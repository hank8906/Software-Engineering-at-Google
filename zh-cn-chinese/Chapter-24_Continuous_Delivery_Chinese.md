第二十四章持續交付

’’’

鑑於技術領域的變化是如此之快且不可預測，任何產品的競爭優勢都在於其快速進入市場的能力。一個組織的速度是其與其他參與者競爭、保持產品和服務質量或適應新法規能力的關鍵因素。這種速度受到部署時間的瓶頸制約。部署不會在初始啓動時只發生一次。教育工作者們有一種說法，沒有一個教案能在第一次與學生接觸後倖存下來。同樣，沒有軟件在第一次發佈時就是完美的，唯一的保證是你需要快速更新它。

’’’’“’”

軟件產品的長期生命週期包括快速探索新想法、快速響應環境行業變化或用戶問題，以及實現大規模開發速度。從埃裏克·雷蒙德（）的《大教堂與集市》（）到埃裏克·賴斯（）的《精益創業》（），任何組織長期成功的關鍵始終在於其能夠儘快將想法付諸實施並交到用戶手中，並對他們的反饋做出快速反應。馬丁·福勒（）在其著作《持續交付》（，又名）中指出，“任何軟件工作的最大風險是，你最終建立的東西並不實用。你越早、越頻繁地將工作中的軟件展現在真正的用戶面前，你就能越快地得到反饋，發現它到底有多大價值。”

“”“”

在交付用戶價值之前進行很長時間的工作是高風險和高成本的，甚至可能會消耗士氣。在谷歌，我們努力做到早期和經常發佈，或者說發佈和迭代，以使團隊能夠迅速看到他們工作的影響，並更快地適應不斷變化的市場。代碼的價值不是在提交時實現的，而是在你的用戶可以使用的功能時實現的。縮短代碼完成和用戶反饋之間的時間，可以將正在進行中的工作的成本降到最低。

當你意識到發射從未着陸，但它開始了一個學習週期，然後你修復下一個最重要的事情，衡量它如何進行，修復下一個事情，等等而且它永遠不會完成。，前谷歌產品經理

在谷歌，我們在本書中描述的做法使數百名（或在某些情況下數千名）工程師能夠快速解決問題，獨立完成新功能而不必擔心發佈問題，並通過實驗瞭解新功能的有效性。本章重點關注快速創新的關鍵措施，包括管理風險、實現大規模的開發者速度，以及瞭解你推出的每個功能的成本和價值權衡。

谷歌持續交付的習慣用法

持續交付（）以及敏捷方法論的一個核心原則是，隨着時間的推移，較小的變更批次能夠產生更高的質量；換句話說，越快越安全。乍一看，這似乎對團隊有很大的爭議，尤其是當建立的前提條件例如，持續集成（）和測試還沒有到位的時候。因爲所有團隊可能需要一段時間才能實現的理想，所以我們將重點放在開發能夠在實現最終目標的過程中獨立交付價值的各個方面。下面是其中的一些：

敏捷性頻繁地、較小的變更批次地發佈。

自動化減少或消除頻繁發佈的重複性開銷。

隔離性努力實現模塊化體系結構，以隔離更改並使故障排除更加容易。

可靠性衡量關鍵的健康指標，如崩潰或延遲，並不斷改善它們。

數據驅動的決策在健康指標上使用測試以確保質量。

分階段推出在向所有人發送之前，先在少數用戶中推廣變更。

’

起初，頻繁發佈新版本的軟件可能看起來很冒險。隨着用戶羣的增長，如果在測試中發現任何錯誤，你可能會擔心用戶的反彈，而且你的產品中可能有太多新代碼，無法徹底測試。但這恰恰是可以幫助的地方。理想情況下，一個版本和下一個版本之間的變化非常少，排除問題是非常簡單的。在極限情況下，有了，每個變化都會通過管道，並自動部署到生產中。對於許多團隊來說，這通常不是一個實際的現實，因此往往需要進行向文化的轉變工作作爲中間步驟，團隊可以在不實際部署的情況下建立部署準備性，增強未來更頻繁發佈的信心。

速度是一項團隊運動：如何將部署工作分解成可管理的部分

’’

當一個團隊較小的時候，代碼變化以一定的速度進入一個代碼庫。我們看到，隨着時間的推移，一個團隊的成長或分裂成子團隊，會出現一種反模式：一個子團隊將其代碼分支，以避免踩到其他團隊的腳，但之後卻會遇到集成和故障排查的問題。在谷歌，我們更傾向於團隊繼續在共享代碼庫中進行開發，並設置測試、自動回滾和故障查找，以快速識別問題。這在第章中有詳細的討論。

’’’

我們的一個代碼庫，，是一個大型的、單體的應用程序。發佈過程很費勁，有、發佈經理和其他志願者。每個發佈版本都需要多次（選擇性合併）代碼變更和重新打包等過程。此外，還有需要由遠程團隊運行的小時手工迴歸測試周期。當一個發佈的操作成本如此之高時，就會形成一個循環，在這個循環中，你要等待測試更多，才能推出發佈版本。與此同時，有人想再增加一個幾乎已經準備好的功能，很快你就有了一個費力、容易出錯和緩慢的發佈過程。最糟糕的是，上次做發佈工作的專家已經精疲力盡，離開了團隊，現在甚至沒有人知道如何解決那些當你試圖發佈更新時發生的奇怪崩潰，讓你一想到要按下那個按鈕就感到恐慌。

如果你的發佈是昂貴的，有時是有風險的，那麼本能的反應是放慢你的發佈節奏，增加你的穩定期。然而，這隻能提供短期的穩定性收益，隨着時間的推移，它會減慢速度，使團隊和用戶感到沮喪。答案是降低成本，增加紀律，使風險更加漸進式，但關鍵是要抵制明顯的操作修復，投資於長期的架構變化。對這個問題的明顯的操作性修正導致了一些傳統的方法：恢復到傳統的計劃模式，爲學習或迭代留下很少的空間，爲開發過程增加更多的治理和監督，以及實施風險審查或獎勵低風險（通常是低價值）的功能。

’

不過，回報率最高的投資是遷移到微服務架構，這可以使一個大型產品團隊有能力保持活力和創新，同時降低風險。在某些情況下，在谷歌，答案是從頭開始重寫一個應用程序，而不是簡單地遷移它，在新的架構中建立所需的模塊化。儘管這兩種選擇都需要幾個月的時間，而且在短期內可能是痛苦的，但在運營成本和認知的簡單性方面獲得的價值將在應用程序多年的生命週期中得到回報。

評估隔離中的更改：標誌保護功能

“”’

可靠的連續發佈的關鍵是確保工程師“通過標誌保護”所有更改。隨着產品的發展，在二進制文件中，將有處於不同開發階段的多種功能共存。以單個功能爲單位，標誌保護位決定了功能的代碼在產品中是否被包含或如何呈現，並可在發佈和開發版本中以不同方式表達。如果編程語言允許，打上”禁用”標誌的功能標誌位會使得構建工具從對應的版本構建中剝離該功能。例如，一個已經提供給客戶的穩定特性可能會在開發版本和發佈版本中啓用。正在開發的功能可能僅爲開發而啓用，從而保護用戶不受未完成功能的影響。新的特性代碼與舊的代碼路徑一起存在於二進制文件中，兩者都可以運行，但新代碼由一個標誌保護。如果新代碼有效，你可以刪除舊代碼路徑，並在後續版本中完全啓動該功能。如果出現問題，可以通過動態配置更新獨立於二進制版本更新標誌值。

在過去的二進制發佈的世界裏，我們必須將新聞發佈時間與二進制發佈時間緊密協調。在發佈關於新功能或新功能的新聞稿之前，我們必須進行成功的發佈。這意味着該功能將在發佈之前就已經公開，提前被發現的風險是非常現實的。

’

這就是標誌守衛的優勢所在。如果新的代碼有一個標誌，標在發佈新功能之前可以立即更新該標誌，從而最大限度地減少泄露功能的風險。請注意，對於真正敏感的功能，有標誌的代碼並不是一個完美的安全網。如果代碼沒有被很好地混淆，它仍然可以被抓取和分析，而且不是所有的功能都可以隱藏在標誌後面而不增加太多複雜性。此外，即使是標誌配置的改變，也必須謹慎地推出。一次性爲的用戶打開一個標誌並不是一個好主意，所以一個能管理安全配置推出的配置服務是一個很好的投資。儘管如此，對於長期可持續性的應用程序而言，控制的水平和將特定功能的命運與整體產品發佈分離的能力是強大的槓桿作用。

爲敏捷而奮鬥：建立一個發佈序列

’’

谷歌搜索是其最早也是最古老的二進制文件。它的代碼庫龐大而複雜，可以追溯到谷歌的起源在我們的代碼庫中搜索，仍然可以找到至少早在年編寫的代碼，通常更早。當智能手機開始使用時，一個接一個的移動功能被塞進了一大堆主要爲服務器部署而編寫的代碼中。儘管搜索體驗變得更加生動和互動，部署一個可行的構建變得越來越困難。有一次，我們每週只發布一次搜索二進制文件到生產中，而即使達到這個目標也是很難得的，而且往往要靠運氣。

’

當我們的貢獻作者之一承擔了提高搜索發佈速度的項目時，每個發佈週期都需要一組工程師幾天才能完成。他們構建了二進制集成數據，然後開始測試。每一個都必須進行手動分類，以確保它不會影響搜索質量、用戶體驗（）和或收入。這一過程既費時又費力，而且不能適應變化的數量和速度。因此，開發人員永遠不可能知道他們的特性將在何時發佈到生產環境中。這使得新聞發佈和公開發布的時間安排具有挑戰性。

’

發佈不是在真空中發生的，擁有可靠的發佈使得依賴性因素更容易同步。在幾年的時間裏，一個專門的工程師小組實施了一個持續的發佈過程，它簡化了關於向世界發送搜索二進制文件的所有工作。我們把我們能做的事情自動化，爲提交功能設定最後期限，並簡化插件和數據到二進制文件的集成。我們現在可以每隔一天發佈一個新的搜索二進制文件。

爲了在發佈週期中獲得可預測性，我們做了哪些權衡？他們把我們融入系統的兩個主要想法歸納了下來。

沒有完美的二進制包

’’

首先，沒有一個二進制包是完美的，，尤其是對於包含數十個或數百個獨立開發幾十個主要功能的開發人員的工作的構建。儘管不可能修復每個，但我們需要不斷權衡這樣的問題：如果一條線向左移動了兩個像素，它會影響廣告顯示和潛在收入嗎？如果盒子的顏色稍微改變了怎麼辦？這是否會讓視障用戶難以閱讀文本？本書的其餘部分可以說是關於最小化發佈的一系列意外結果，但最終我們必須承認軟件從根本上來說是複雜的。沒有完美的二進制包每當有新的變化發佈到生產中時，就必須做出決定和權衡。具有明確閾值的關鍵性能指標允許功能在不完美的情況下推出，也可以在其他有爭議的發佈決策中創造清晰的思路。

其中一個涉及一種罕見的方言，這種方言只在菲律賓的一個島嶼上使用。如果用戶用這種方言問搜索問題，而不是回答他們的問題，他們會得到一個空白網頁。我們必須確定修復這個的成本是否值得推遲發佈一個重要的新特性。

’

我們奔走於各個辦公室，試圖確定究竟有多少人講這種語言，是否每次用戶用這種語言搜索時都會出現這種情況，以及這些人是否經常使用谷歌。每個與我們交談的質量工程師都把我們推給更高級別的人。最後，數據在手，我們把問題交給了搜索部的高級副總裁。我們是否應該推遲一個重要的版本來修復一個隻影響到菲律賓一個很小的島嶼的錯誤？事實證明，無論你的島有多小，你都應該得到可靠和準確的搜索結果：我們推遲了發佈，並修復了這個錯誤。

>“”>>記住的錯誤預算表述：完美很少是最佳目標。瞭解多少誤差空間是可以接受的，以及該預算最近花了多少，並利用這一點來調整速度和穩定性之間的權衡。

滿足你的發佈期限

’’“”’

第二個想法是，如果你趕不上發佈列車，它就會丟下你離開。有一句格言值得一提，“最後期限是確定的，而生活不是。”在發佈時間表的某個時刻，你必須立木取信，拒絕開發人員及其新功能。一般來說，在截止日期過後，無論多少懇求或乞求都不會在今天的版本中出現。

’’’’’

有一個罕見的例外。這種情況通常是這樣的。週五晚間，六名軟件工程師驚慌失措地衝進發布經理的辦公室。他們與簽訂了合同，並在不久前完成了這個功能。但它必須在明天的大比賽之前上線。發佈必須停止，我們必須將該特性插入二進制包，否則我們將違反合同！。一個目光呆滯的發佈工程師搖搖頭，說切割和測試一個新的二進制文件需要四個小時。今天是他們孩子的生日，他們還需要帶着氣球回家。

’

定期發佈的世界意味着，如果開發人員錯過了發版班車，他們將能夠在幾個小時而不是幾天內趕上下一班班車。這限制了開發人員的恐慌，並大大改善了發佈工程師的工作與生活平衡。

質量和用戶關注點：只提供使用的產品

’’

臃腫是大多數軟件開發生命週期的一個不幸的副作用，產品越成功，其代碼庫通常就越臃腫。快速、高效的發佈系列的一個缺點是，這種臃腫經常被放大，並可能表現爲對產品團隊甚至用戶的挑戰。特別是如果軟件交付給客戶端（如移動應用程序），這可能意味着用戶的設備要支付空間、下載和數據成本，即使是他們從未使用過的功能，而開發人員要支付構建速度較慢、部署複雜和罕見的成本。在本節中，我們將討論動態部署如何允許你僅發佈所使用的內容，從而在用戶價值和功能成本之間進行必要的權衡。在谷歌，這通常意味着配備專門的團隊，以不斷提高產品的效率。

’

有些產品是基於網絡並在雲上運行的，而許多產品是客戶端應用程序，使用用戶設備上的共享資源手機或平板電腦。這種選擇本身就展示了原生應用之間的權衡，原生應用可以有更高的性能，對不穩定的連接有彈性，但也更難更新，更容易受到平臺問題的影響。反對原生應用頻繁、持續部署的一個常見論點是，用戶不喜歡頻繁的更新，而且必須爲數據成本和中斷付費。可能還有其他限制因素，如訪問網絡或限制滲透更新所需的重新啓動。

’

即使在更新產品的頻率方面需要做出權衡，但目標是讓這些選擇是有意的決策。有了一個平滑、運行良好的流程，創建一個可行版本的頻率可以與用戶收到它的頻率分開。你可能會實現每週、每天或每小時部署一次的目標，但實際上並沒有這樣做。你應該根據用戶的具體需求和更大的組織目標有意識地選擇發佈流程，並確定最能支持產品長期可持續性的人員配置和工具模型。

’’’

在本章的前面部分，我們討論了保持代碼模塊化。這允許動態、可配置的部署，以便更好地利用有限資源，例如用戶設備上的空間。在沒有這種實踐的情況下，每個用戶都必須收到他們永遠不會使用的代碼，以支持他們不需要的翻譯或用於其他類型設備的架構。動態部署允許應用程序保持較小的尺寸，同時只將代碼發送給能爲用戶帶來價值的設備，而實驗允許在功能的成本及其對用戶和企業的價值之間進行有意義的權衡。

建立這些流程是有前期成本的，識別和消除使發佈頻率低於理想水平的阻力是一個艱苦的工作。但是，在風險管理、開發者速度和實現快速創新方面的長期勝利是如此之高，以至於這些初始成本是值得的。

左移：提前做出數據驅動的決策

’’

如果你是爲所有用戶建立應用程序，你可能在智能屏幕、揚聲器或和手機和平板電腦上有客戶，你的軟件可能足夠靈活，允許用戶定製他們的體驗。即使你只爲安卓設備構建，超過億的安卓設備的多樣性也會使一個版本的場景變得不堪重負。隨着創新的步伐，當有人讀到這一章時，全新的設備類別可能已經出現。

’

我們的一位發佈經理分享了一條智慧，他說我們客戶市場的多樣性不是問題，而是事實，這扭轉了局面。在我們接受後，我們可以通過以下方式切換我們的發佈資格模型：

如果全面的測試實際上是不可行的，就以代表性的測試爲目標。分階段向用戶羣中慢慢增加的百分比進行發佈，可以快速修復問題。自動的發佈允許統計學上有意義的結果來證明一個版本的質量，而無需疲憊的人去看儀表盤和做決定。

在爲客戶端開發時，谷歌應用程序使用專門的測試軌道和分階段推出，以增加用戶流量的百分比，仔細監控這些渠道中的問題。由於提供無限的測試軌道，我們還可以在我們計劃推出的每個國家地區建立一個團隊，允許在全球範圍內一夜之間完成關鍵功能的測試。

我們在部署時注意到的一個問題是，僅僅通過推送更新，我們就可以預期用戶指標會發生統計上的顯著變化。這意味着，即使我們沒有對產品進行任何更改，推動更新也可能以難以預測的方式影響設備和用戶行爲。因此，儘管對一小部分用戶流量進行更新可以爲我們提供關於崩潰或穩定性問題的良好信息，但它幾乎沒有告訴我們更新版本的應用程序是否比舊版本更好。

和已經討論了測試的價值，但在，我們的一些大型應用也對其部署進行測試。這意味着發送兩個版本的產品：一個是所需的更新，基線是一個安慰劑（你的舊版本只是被再次發送）。當這兩個版本同時向足夠多的類似用戶推出時，你可以將一個版本與另一個版本進行比較，看看你的軟件的最新版本是否真的比以前的版本有所改進。有了足夠大的用戶羣，你應該能夠在幾天內，甚至幾小時內得到統計學上的顯著結果。一個自動化的指標管道可以實現最快的發佈，只要有足夠的數據知道護欄指標不會受到影響，就可以將一個版本推到更多的流量。

’

顯然，這種方法並不適用於每個應用程序，當你沒有足夠大的用戶羣時，可能會有很多開銷。在這種情況下，推薦的最佳做法是以變化中立的發佈爲目標。所有的新功能都有標誌保護，這樣在發佈過程中測試的唯一變化就是部署本身的穩定性。

>>>和，《測試：將點擊轉化爲客戶的最有效方式》（，）。

改變團隊文化：在部署中建立規則

“”’

儘管“始終進行部署”有助於解決影響開發人員速度的幾個問題，但也有一些實踐可以解決規模問題。啓動產品的初始團隊可以少於人，每個人輪流負責部署和生產監控。隨着時間的推移，你的團隊可能會發展到數百人，其中的子團隊負責特定的功能。隨着這種情況的發生和組織規模的擴大，每次部署中的更改數量和每次發佈嘗試中的風險量都呈超線性增長。每次發佈都包含數月的汗水和淚水。使發佈成功成爲一項高度溝通和勞動密集型的工作。開發人員經常會被發現試圖決定哪一個更糟糕：放棄一個包含四分之一新特性和錯誤修復的版本，或者在對其質量沒有信心的情況下推出一個版本。

“”’

在規模擴大時，複雜性的增加通常表現爲發佈延遲的增加。即使你每天都發布，一個版本也可能需要一週或更長的時間才能完全安全地發佈，當你試圖調試任何問題時，就會落後一週。這就是始終進行部署可以使開發項目恢復到有效狀態的地方。頻繁的發版班車允許從一個已知的良好狀態中產生最小的偏差，變化的頻率有助於解決問題。但是，一個團隊如何才能確保一個龐大而快速擴展的代碼庫所固有的複雜性不會拖累進度呢？

在谷歌地圖上，我們的觀點是：功能是非常重要的，但只有在非常少的情況下，纔會有如此重要的功能需要發佈。如果發佈的頻率很高，那麼一個功能因爲錯過了一個版本而感到的痛苦與一個版本中所有的新功能因爲延遲而感到的痛苦相比是很小的，特別是如果一個還沒有準備好的功能被匆忙納入，用戶會感到痛苦。

一個發佈責任是保護產品不受開發人員的影響。

在進行權衡時，開發人員對推出新功能的熱情和緊迫感永遠不能超過對現有產品的用戶體驗。這意味着，新功能必須通過具有強大契約的接口、關注點分離、嚴格測試、早期和經常的溝通以及新功能驗收的慣例，與其他組件隔離。

總結

’

多年來，在我們所有的軟件產品中，我們發現，相反，更快更安全。你的產品的健康狀況和開發速度實際上並不是相互對立的，更頻繁和小批量發佈的產品具有更好的質量結果。它們能更快地適應在野外遇到的錯誤和意外的市場變化。不僅如此，更快就是便宜，因爲有一個可預測的、頻繁的發版班車，迫使你降低每個版本的成本，並使任何被放棄的發佈的成本非常低。

’’

僅僅擁有能夠持續部署的結構，就能產生大部分的價值，即使你沒有真正把這些版本推送給用戶。我們的意思是什麼呢？我們實際上並不是每天都發佈一個完全不同的搜索、地圖或的版本，但要做到這一點，就需要一個健壯的、有良好文檔記錄的連續部署過程、關於用戶滿意度和產品健康狀況的準確實時指標，以及一個協調一致的團隊，該團隊擁有明確的策略，以確定成功與否以及原因。在實踐中，要做到這一點，往往還需要可以在生產中配置的二進制包，像代碼一樣管理的配置（在版本控制中），以及一個可以採取安全措施的工具鏈，如干運行驗證、回滾前滾機制和可靠的補丁。

內容提要

’’

速度是一項團隊運動。協作開發代碼的大型團隊的最佳工作流程需要架構的模塊化和近乎連續的集成。孤立地評估變化。對任何功能進行標記，以便能夠儘早隔離問題。讓現實成爲你的基準。使用分階段推出的方式來解決設備的多樣性和用戶羣的廣泛性。在一個與生產環境不相似的合成環境中進行發佈鑑定，會導致後期的意外。只發布被使用的東西。監控任何功能的成本和價值，以瞭解它是否仍有意義，是否能提供足夠的用戶價值。向左移動。通過和持續部署，使所有的變化更快，更多的數據驅動的決策更早。更快是更安全的。儘早地、經常地、小批量地發佈，以減少每次發佈的風險，並儘量縮短上市時間。