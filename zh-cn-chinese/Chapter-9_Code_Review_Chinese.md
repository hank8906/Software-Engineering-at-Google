第九章代碼審查

“”

代碼審查是一個由作者以外的人對代碼進行審查的過程，通常在將該代碼引入代碼庫之前。儘管這是一個簡單的定義，但在整個軟件行業中，代碼審查過程的實施有很大不同。一些組織在代碼庫中擁有一組挑選出來的守門人來審查修改。其他人將代碼審查過程委託給這個小團隊，允許不同的團隊要求不同級別的代碼審查。在谷歌，基本上每一個改動在提交之前都會被審查，每個工程師都負責啓動審查和審查變更。

代碼審查通常需要一個流程和一個支持該流程的工具的組合。在，我們使用一個定製的代碼審查工具來支持我們的流程。在是一個非常重要的工具，足以讓它在本書中佔有一章。本章重點介紹實施的代碼審查流程，而不是具體的工具，這是因爲這些基礎比工具更古老，而且這些見解大多可以適應你可能用於代碼審查的任何工具。

’

代碼審查的一些好處，例如在代碼進入代碼庫之前檢測到代碼中的錯誤，已經得到了很好的證實，而且有點明顯（如果測量不精確的話）。然而，其他的好處則更爲微妙。由於谷歌的代碼審查過程是如此的普遍和廣泛，我們已經注意到了許多這些更微妙的影響，包括心理上的影響，隨着時間的推移和規模的擴大，會給一個組織帶來許多好處。

>>>我們也使用來審查代碼，主要用於我們的開源項目。然而，是谷歌公司典型的軟件工程師的主要工具。>>>>史蒂夫·麥康奈爾雷蒙德：微軟出版社，年

代碼審查流程

“”“”

代碼評審可以發生在軟件開發的多個階段。在谷歌，代碼評審是在更改提交到代碼庫之前進行的；這個階段也被稱爲預提交審查。代碼評審的主要最終目標是讓另一位工程師同意變更，我們通過將變更標記爲“我覺得不錯”（）來表示。我們將此用作必要的權限“標識”（與下面提到的其他標識結合使用），以允許提交更改。

“”’

谷歌的典型代碼審查過程如下：

用戶在其工作區的代碼庫中寫入一個變更。然後作者創建變更的快照：一個補丁和相應的描述，上傳到代碼審查工具。此更改會產生與代碼庫的差異，用於評估已更改的代碼。作者可以使用此初始補丁應用自動審查評論或進行自我審查。當作者對變更的差異感到滿意時，他們會將變更郵寄給一個或多個審查者。此過程通知這些審查者，要求他們查看快照並對其進行評論。審查者在代碼審閱工具中打開更改，並在差異上發表評論。有些評論要求明確的解決。有些僅僅是信息性的。作者根據反饋意見修改修改，並上傳新的快照，然後回覆給審查者。步驟和可重複多次。在審查員對變更的最新狀態感到滿意後，他們同意變更，並通過將其標記爲“我覺得不錯”（）來接受變更。默認情況下，只需要一個，儘管慣例可能要求所有審覈人同意變更。在更改被標記爲之後，作者可以將更改提交到代碼庫，前提是他們解決所有評論，並且該變更被批准。我們將在下一節中討論批准問題。

’

我們將在本章後面更詳細地介紹這個過程。

編碼是一種責任

’

重要的是要記住（並接受），編碼本身就是一種責任。它可能是一種必要的責任，但就其本身而言，編碼只是某個人的一項維護任務。就像飛機攜帶的燃料一樣，它有重量，儘管它當然是飛機飛行的必要條件。

“’’”

當然，新特性通常是必需的，但在開發代碼之前，首先要注意確保任何新特性都是有必要的。重複的代碼不僅是一種浪費，而且實際上比根本沒有代碼要花費更多的時間；當代碼庫中存在重複時，可以在一個代碼模式下輕鬆執行的更改通常需要更多的工作。編寫全新的代碼是如此令人不快，以至於我們中的一些人都有這樣一句話：“如果你是從頭開始寫的，那你就是做錯了！”

’

這對於類庫或實用程序代碼來說尤其如此。有可能，如果你正在寫一個實用程序，那麼在像那樣大的代碼庫中，其他人可能已經做了類似的事情。因此，像那些在第章中討論的工具對於找到這些實用程序代碼和防止引入重複的代碼都是至關重要的。理想情況下，這種研究是事先完成的，在編寫任何新的代碼之前，任何新的設計都已經傳達給合適的小組。

當然，新項目的發生，新技術的引入，新組件的需要，等等。綜上所述，代碼審查並不是一個重提或辯論以前的設計決策的時機。設計決策通常需要時間，需要分發設計方案，在評審或類似的會議上對設計進行辯論，也許還需要開發原型。就像對全新的代碼進行代碼審查不應該突然出現一樣，代碼審查過程本身也不應該被看作是重新審視以前決策的時機。

谷歌的代碼審查工作

’

我們已經粗略地指出了典型的代碼審查過程是如何工作的，但問題在於細節。本節詳細概述了谷歌的代碼審查工作原理，以及這些實踐如何使其能夠隨時間適當擴展。

“”

“”“”’’’“”’

對於的任何特定變化，有三個方面的審查需要批准：

由另一位工程師進行的正確性和可讀性檢查，檢查代碼是否合適，以及代碼是否符合作者的要求。這通常是一個團隊成員，儘管不一定是。這反映在權限的標識上，在同行審查者同意代碼看起來不錯之後，該標識將被設置。來自代碼所有者之一的批准，即該代碼適合於代碼庫的這個特定部分（並且可以被檢查到一個特定的目錄）。如果作者是這樣一個所有者，這種批准可能是隱含的。谷歌的代碼庫是一個樹狀結構，有特定目錄的分層所有者。見第章）。所有者作爲他們特定目錄的看門人。任何工程師都可以提出修改意見，任何其他工程師也可以提出，但有關目錄的所有者必須批准在他們的代碼庫中加入這一內容。這樣的所有者可能是技術領導或其他被認爲是代碼庫特定領域的專家的工程師。通常由每個團隊決定分配所有權特權的範圍是寬還是窄。擁有語言可讀性的人批准代碼符合語言的風格和最佳實踐，檢查代碼是否以我們期望的方式編寫。如果作者有這樣的可讀性，這種認可又可能是隱含的。這些工程師來自公司範圍內的工程師隊伍，他們被授予了該編程語言的可讀性。

雖然這種程度的控制聽起來很繁瑣而且，不可否認，有時的確如此但大多數審查都是由一個人承擔這三個角色，這就大大加快了審查過程。重要的是，作者也可以承擔後兩個角色，只需要另一個工程師的就可以將代碼檢查到他們自己的代碼庫中，前提是他們已經具備了該語言的可讀性（所有者經常這樣做）。

’“”

這些要求使得代碼審查過程非常靈活。技術負責人是一個項目的所有者，並且具有代碼的語言可讀性，可以只使用另一個工程師的提交代碼更改。沒有這種權限的實習生可以將相同的更改提交給相同的代碼庫，前提是他們獲得具有語言可讀性的所有者的批准。上述三個許可“標識”可以任意組合。作者甚至可以從不同的人處請求多個，方法是明確地將更改標記爲希望從所有審閱者處獲得。

“”“”“”

在實踐中，大多數需要不止一次批准的代碼評審通常經歷兩個步驟：從同行工程師那裏獲得，然後從適當的代碼所有者可讀性審查員處尋求批准。這使得這兩個角色可以專注於代碼審查的不同方面，並節省審查時間。主要的審查者可以專注於代碼的正確性和代碼修改的一般有效性；代碼所有者可以關注此更改是否適合他們的部分，而不必關注每行代碼的細節。換句話說，審批者所尋找的東西往往與同行評審者不同。畢竟，有人是想把代碼簽入他們的項目目錄。他們更關心的是諸如以下問題。這段代碼是容易還是難以維護？它是否增加了我的技術債務？我們的團隊中是否有維護它的專業知識？

如果這三種類型的審查都可以由一個審查員處理，爲什麼不直接讓這些類型的審查員處理所有的代碼審查呢？簡單的答案是規模。將這三種角色分開，可以增加代碼審查過程的靈活性。如果你和同行一起在一個實用程序庫中開發一個新的函數，你可以讓你團隊中的某人來審查代碼的正確性和理解性。經過幾輪（也許是幾天的時間），你的代碼讓你的同行審查員滿意，你就會得到一個。現在，你只需要讓該庫的所有者（而所有者往往具有適當的可讀性）批准這項修改。

>“”>>在谷歌，“可讀性”不僅僅指理解能力，而是指允許其他工程師維護代碼的一套風格和最佳實踐。見第章。

所有權

’

當一個小團隊在專門的版本庫中工作時，通常會授予整個團隊對版本庫中所有內容的訪問權。畢竟，你認識其他的工程師，這個領域很窄，你們每個人都可以成爲專家，而且人數少限制了潛在錯誤的影響範圍。

’“”

隨着團隊規模的擴大，這種方法可能無法擴展。其結果要麼是混亂的版本庫分裂，要麼是用不同的方法來記錄誰在版本庫的不同部分擁有哪些知識和職責。在谷歌，我們把這套知識和職責稱爲所有權，把行使這些知識和職責的人稱爲所有者。這個概念不同於對源代碼集合的佔有，而是意味着一種管理意識，以公司的最佳利益對代碼庫的某個部分採取行動。事實上，如果我們重新來過，管家幾乎肯定是一個更好的術語）。

特別命名的文件列出了對一個目錄及其子目錄有所有權責任的人的用戶名。這些文件也可能包含對其他文件或外部訪問控制列表的引用，但最終它們會解析爲個人列表。每個子目錄也可能包含一個單獨的文件，而且這種關係是分層遞增的：一個給定的文件通常由目錄樹中它上面的所有文件的成員共同擁有。文件可以有任意多的條目，但我們鼓勵一個相對較小和集中的列表，以確保責任明確。

’’

對谷歌代碼的所有權傳達了對其權限範圍內的代碼的批准權，但這些權利也伴隨着一系列的責任，如瞭解所擁有的代碼或知道如何找到擁有這些代碼的人。不同的團隊在授予新成員所有權方面有不同的標準，但我們通常鼓勵他們不要把所有權作爲入職儀式，並鼓勵離職的成員在可行的情況下儘快放棄所有權。

’’

這種分佈式所有權結構使我們在本書中概述的許多其他做法成爲可能。例如，根文件中的一組人可以作爲大規模修改的全球批准者（見第章），而不必打擾本地團隊。同樣，文件作爲一種文檔，使人們和工具很容易找到對某段代碼負責的人，只要沿着目錄樹走就可以了。當新項目被創建時，沒有一箇中央機構需要註冊新的所有權權限：一個新的文件就足夠了。

這種所有權機制簡單而強大，在過去的年裏得到了良好的擴展。這是谷歌確保數以萬計的工程師能夠在單一資源庫中有效操作數十億行代碼的方法之一。

代碼審查的好處

縱觀整個行業，代碼審查本身並不存在爭議，儘管它還遠不是一種普遍的做法。許多（甚至可能是大多數）其他公司和開源項目都有某種形式的代碼審查，而且大多數人認爲這個過程很重要，是對引入新代碼到代碼庫的合理檢查。軟件工程師理解代碼審查的一些更明顯的好處，即使他們個人可能不認爲它適用於所有情況。但在谷歌，這個過程通常比其他大多數公司更徹底、更廣泛。

’

谷歌的文化，就像許多軟件公司的文化一樣，是基於給工程師們在工作中的自由度。人們認識到，對於需要對新技術做出快速反應的充滿活力的公司來說，嚴格的流程往往不起作用，而官僚主義的規則往往不適合創造性專業人士。然而，代碼審查是一項任務，是谷歌所有軟件工程師都必須參與的少數全流程之一。谷歌要求對代碼庫的每一次代碼修改都要進行代碼審查，無論多麼微小。這個任務確實對工程速度有成本和影響，因爲它確實減緩了將新代碼引入代碼庫的速度，並可能影響任何特定代碼更改的生產時間。這兩點是軟件工程師對嚴格的代碼審查過程的常見抱怨）。那麼，爲什麼我們要要求這個過程？爲什麼我們相信這是一個長期有利的？

一個精心設計的代碼審查過程和認真對待代碼審查的文化會帶來以下好處：

檢查代碼的正確性確保其他工程師能夠理解代碼更改強化整個代碼庫的一致性從心理上促進團隊的所有權實現知識共享提供代碼審查本身的歷史記錄

隨着時間的推移，這些好處對一個軟件組織來說是至關重要的，其中許多好處不僅對作者有利，而且對審查員也有利。下面的章節將對這些項目中的每一項進行更詳細的說明。

>>>對文檔和配置的某些更改可能不需要代碼審查，但通常仍然可以獲得這樣的審查。

代碼正確性

“”

代碼審查的一個明顯的好處是，它允許審查者檢查代碼更改的正確性。讓另一雙眼睛來審視一個更改，有助於確保這個更改能達到預期效果。審查員通常會檢查一個變更是否有適當的測試，設計是否合理，功能是否正確和有效。在許多情況下，檢查代碼正確性就是檢查特定的更改是否會將引入代碼庫。

’

許多報告指出了代碼審查在防止軟件未來出現錯誤方面的有效性。的一項研究發現，在一個過程的越早發現缺陷，無疑會減少以後修復缺陷所需的時間。對代碼審查時間的投入節省了原本用於測試、調試和執行迴歸的時間，前提是代碼審查過程本身經過了優化，以保持其輕量級。如果代碼審查過程很重，或者擴展不當，那麼這些過程將變得不可持續。我們將在本章後面介紹一些保持過程輕量級的最佳實踐。

’“”

爲了防止正確性評估變得更加主觀而非客觀，作者通常會遵循其特定方法，無論是在設計中還是在引入變更的功能中。審查員不應該因爲個人意見而提出替代方案。審查員可以提出替代方案，但前提是這些替代方案能夠改善理解性（例如，通過降低複雜性）或功能性（例如，通過提高效率）。一般來說，鼓勵工程師批准改進代碼庫的更改，而不是等待就更“完美”的解決方案達成共識。這種關注傾向於加速代碼審查。

隨着工具越來越強大，許多正確性檢查會通過靜態分析和自動測試等技術自動執行（儘管工具可能永遠不會完全消除基於人工的代碼檢查的價值，更多信息請參見第章）。儘管這種工具有其侷限性，但它明確地說明了需要依靠基於人工的代碼檢查來檢查代碼的正確性。

“”’“”

這就是說，在最初的代碼審查過程中檢查缺陷仍然是一般“左移”策略的一個組成部分，旨在儘早發現和解決問題，從而避免在開發週期中進一步增加成本和資源。代碼審查既不是萬靈藥，也不是檢查這種正確性的唯一方法，但它是深入防禦軟件中此類問題的一個要素。因此，代碼審查不需要“完美”才能取得成果。

“”

令人驚訝的是，檢查代碼的正確性並不是谷歌從代碼審查過程中獲得的最大好處。檢查代碼正確性通常可以確保更改有效，但更重要的是確保代碼更改是可以理解的，並且隨着時間的推移和代碼庫本身的擴展而變得有意義。爲了評估這些方面，我們需要查看除代碼在邏輯上是否“正確”或理解之外的其他因素。

>“”>>誠然，這項研究發生在強大的工具和自動測試在軟件開發過程中變得如此重要之前，但其結果在現代軟件時代似乎仍有意義。>>“”>>趨同的軟件同行評審實踐。。年第九屆軟件工程基礎聯席會議論文集》，年月：。。

代碼理解

’

代碼審查通常是作者以外的人檢查修改的第一個時機。這種視角使審查者能夠做到最好的工程師也做不到的事情：提供不受作者視角影響的反饋。代碼審查通常是對一個特定的變更是否能被更多的人理解的第一個測試。這種觀點是非常重要的，因爲代碼被閱讀的次數要比它被寫的次數多得多，而理解和領悟是非常重要的。

’“”’

找到一個與作者觀點不同的讀者通常是很有用的，特別是一個審查員，作爲他們工作的一部分，可能需要維護或使用修改中提出的代碼。與審查員在設計決策方面應該給予作者的尊重不同，用客戶永遠是對的這一格言來對待代碼理解方面的問題往往是有用的。在某種程度上，你現在得到的任何問題都會隨着時間的推移而成倍增加，所以要把每個關於代碼理解的問題看作是有效的。這並不意味着你需要改變你的方法或邏輯來回應批評，但這確實意味着你可能需要更清楚地解釋它。

代碼正確性和代碼理解力的檢查共同構成了另一個工程師的的主要標準，這也是一個被批准的代碼審查所需的批准之一。當一個工程師將代碼審查標記爲時，他們是在說，代碼做了它所說的事情，而且它是可以理解的。然而，谷歌也要求代碼是可持續維護的，所以我們在某些情況下對代碼還需要額外的批准。

代碼的一致性

’

在規模上，你寫的代碼會被別人依賴，並最終由其他人維護。許多人需要閱讀你的代碼並瞭解你的工作。在你轉移到另一個項目之後很長時間後，其他人（包括自動化工具）可能需要重構你的代碼。因此，代碼需要符合一些一致性的標準，這樣它才能被理解和維護。代碼也應避免過於複雜；簡單的代碼對其他人來說也更容易理解和維護。審查員可以在代碼評審中評估這些代碼是否符合代碼庫本身的標準。因此，代碼審查的作用應該是確保代碼的健康。

“”

正是爲了可維護性，代碼審查的狀態（表示代碼的正確性和理解力）與可讀性批准的狀態是分開的。可讀性的批准只能由成功通過特定編程語言的代碼可讀性培訓過程的人授予。例如，代碼需要有可讀性的工程師來批准。

’’

可讀性審查員的任務是審查代碼，以確保它遵循該特定編程語言的商定的最佳做法，與谷歌代碼庫中該語言的代碼庫一致，並避免過於複雜。一致和簡單的代碼更容易理解，當需要重構時，工具也更容易更新，使其更有擴展性。如果一個特定的模式在代碼庫中總是以一種方式完成，那麼寫一個工具來重構它就會更容易。

“”

此外，代碼可能只編寫一次，但它將被讀取數十次、數百次甚至數千次。在整個代碼庫中使用一致的代碼可以提高對所有工程的理解，這種一致性甚至會影響代碼評審本身的過程。一致性有時與功能衝突；可讀性審查員可能更喜歡不太複雜的更改，這些更改在功能上可能不是“更好”，但更容易理解。

’

有了一個更加一致的代碼庫，工程師就更容易介入並審查別人項目的代碼。工程師們可能偶爾需要向團隊外尋求代碼審查方面的幫助。能夠伸出援手，請專家來審查代碼，知道他們可以期望代碼本身是一致的，使這些工程師能夠更正確地關注代碼的正確性和理解。

心理和文化方面的好處

“”

代碼審查還有重要的文化好處：它向軟件工程師強調代碼不是“他們的”，而是事實上集體事業的一部分。這種心理上的好處可能很微妙，但仍然很重要。沒有代碼審查，大多數工程師自然會傾向於個人風格和他們自己的軟件設計方法。代碼審查過程迫使作者不僅要讓別人提出意見，而且要爲了更大的利益做出妥協。

’’’“”’“”“”

以自己的手藝爲榮，不願意公開自己的代碼接受他人的批評，這是人類的天性。對於自己寫的代碼的批評性反饋，也很自然地不願意接受。代碼審查過程提供了一個機制，以減輕可能是一個情緒化的互動。如果代碼審查效果最佳，它不僅會對工程師的假設提出質疑，而且還會以規定的、中立的方式提出質疑，如果以未經請求的方式提出批評，則可能會對作者提出批評。畢竟，這個過程需要批判性的審查（事實上，我們把我們的代碼審查工具稱爲批判），所以你不能責怪審查者做他們的工作和批評。因此，代碼審查過程本身可以充當壞警察，而審查者仍然可以被看作是好警察。

’

當然，不是所有的，甚至是大多數的工程師都需要這樣的心理措施。但是，通過代碼審查的過程來緩解這種批評，往往能爲大多數工程師提供一個更溫和的指導，讓他們瞭解團隊的期望。許多加入谷歌的工程師，或者一個新的團隊，都被代碼審查所嚇倒。我們很容易認爲任何形式的批評性審查都會對一個人的工作表現產生負面影響。但是，隨着時間的推移，幾乎所有的工程師都期望在發送代碼審查時受到挑戰，並開始重視通過這一過程提供的建議和問題（儘管，無可否認，這有時需要一段時間）。

’’

代碼審查的另一個心理好處是驗證。即使是最有能力的工程師也可能患上冒名頂替綜合症，過於自我批評。像代碼評審這樣的過程是對一個人工作的確認和認可。通常，該過程涉及思想交流和知識共享（將在下一節中介紹），這對審覈人和被審覈人都有好處。隨着工程師領域知識的增長，他們有時很難獲得關於如何改進的積極反饋。代碼審查過程可以提供這種機制。

“”’“’”’

啓動代碼審查的過程也迫使所有作者對他們的更改多加註意。許多軟件工程師並不是完美主義者；大多數人都會承認，能完成工作的代碼要比完美但開發時間太長的代碼要好。我們中的許多人會抄近路是很自然的，即使我們完全打算在以後糾正這些缺陷。當然，我沒有完成所有的單元測試，但我可以以後再做。代碼審查迫使工程師在發送修改前解決這些問題。從心理上講，爲代碼審查而收集修改的組成部分，迫使工程師確保他們所有的事情都是一帆風順的。在發送修改前的那一小段思考時間是閱讀修改的最佳時機，以確保你沒有遺漏任何東西。

知識共享

“”

代碼審查的一個最重要的，但被低估的好處是知識共享。大多數作者挑選的審查員都是被審查領域的專家，或者至少在所審查的領域有知識。審查過程允許審查員向作者傳授領域知識，允許審查員向作者提供建議、新技術或諮詢信息。審查員甚至可以把一些評論標記爲僅供參考，不需要採取任何行動；它們只是作爲作者的一種幫助而被添加進來）。在代碼庫某個領域特別精通的作者通常也會成爲所有者，而後者又可以作爲其他工程師的評審員。

反饋和確認的代碼評審過程的一部分包括詢問爲什麼以特定方式進行更改。這種信息交流有助於知識共享。事實上，許多代碼評審都涉及雙向信息交換：作者和審查員都可以從代碼評審中學習新的技術和模式。在谷歌，審查員甚至可以直接在代碼審查工具中與作者分享建議的編輯。

’“”

工程師可能不會閱讀每一封發給他們的電子郵件，但他們往往會回覆每一封發送的代碼審查。這種知識共享也可以跨越時區和項目，利用谷歌的規模將信息迅速傳播到代碼庫的各個角落的工程師。代碼審查是知識轉移的最佳時機：它是及時和可操作的。谷歌的許多工程師首先通過代碼審查認識其他工程師！）。

’

考慮到谷歌工程師花在代碼審查上的時間，積累的知識相當重要。當然，谷歌工程師的主要任務仍然是編程，但他們的大部分時間仍然花在代碼審查上。代碼評審過程提供了軟件工程師相互交流和交換編碼技術信息的主要方式之一。通常，新模式是在代碼審查的上下文中發佈的，有時是通過重構（如大規模更改）發佈的。

此外，由於每個更改都成爲代碼庫的一部分，所以代碼評審充當歷史記錄。任何工程師都可以檢查谷歌的代碼庫，並確定何時引入某些特定的模式，並提出有關的實際代碼審查。通常情況下，這種考古學爲比原作者和審查者更多的工程師提供了洞察力。

代碼評審最佳實踐

誠然，代碼審查會給一個組織帶來阻力和延遲。這些問題大多不是代碼審查本身的問題，而是他們選擇的代碼審查實施的問題。在谷歌保持代碼審查過程的順利運行也不例外，它需要大量的最佳實踐來確保代碼審查是值得的。大多數實踐都強調保持流程的敏捷性和快速性，以便代碼評審能夠適當地擴展。

要有禮貌和專業精神

正如本書文化部分所指出的，谷歌大力培育信任和尊重的文化。這將深入到我們對代碼審查的觀點中。例如，軟件工程師只需要一個來自其他工程師的就可以滿足我們對代碼理解的要求。許多工程師在作出更改後提出意見和，並理解這些更改可以在做出更改後提交，而無需進行任何額外的審查。也就是說，即使是最有能力的工程師，代碼審查也會帶來焦慮和壓力。在專業領域中，堅定地保留所有反饋和批評是至關重要的。

’’’

一般來說，審查員應該在特定的方法上聽從作者的意見，只有在作者的方法有缺陷時才指出替代方法。如果作者能證明幾種方法同樣有效，審查員應該接受作者的偏好。即使在這些情況下，如果發現一個方法有缺陷，也要把審查看作是一個學習的機會（對雙方都是如此！）。所有的評論都應該嚴格保持專業性。審查員應該注意不要根據代碼作者的特定方法就下結論。在假設該方法是錯誤的之前，最好先問一下爲什麼要這樣做。

’’

審查員應及時提供反饋。在谷歌，我們希望在（工作）小時內得到代碼審查的反饋。如果審查員無法在這段時間內完成審查，那麼良好的做法是（也是我們所期望的）回應說他們至少已經看到了更改，並將儘快進行審查。審查員應該避免以零散的方式回應代碼評審。沒有什麼事情比從審查中得到反饋，解決它，然後繼續在審查過程中得到無關的進一步反饋更讓作者惱火。

“”’

就像我們期望審查員有專業精神一樣，我們也期望作者有專業精神。記住，你不是你的代碼，你提出的這個修改不是你的，而是團隊的。在你把這段代碼檢查到代碼庫中後，它無論如何都不再是你的了。要樂於接受關於你的方法的問題，並準備好解釋你爲什麼以某種方式做事情。記住，作者的部分責任是確保這段代碼是可以理解的，並且可以爲將來維護。

’’’’

重要的是要把代碼審查中的每個審查者的評論當作一個項目；一個特定的評論可能不需要被無條件接受，但它至少應該被解決。如果你不同意一個評審員的評論，讓他們知道，並讓他們知道爲什麼，在雙方都有機會提供替代方案之前，不要把評論標記爲已解決。如果作者不同意審查員的意見，保持這種辯論的一個常見方法是提供一個替代方案，並要求評審員（請再看看）。記住，代碼審查對於審查者和作者來說都是一個學習的機會。這種洞察力往往有助於減少任何分歧的場景。

同樣的道理，如果你是代碼的所有者，並且在你的代碼庫中對代碼審查做出回應，那麼就應該對來自外部作者的改動持寬容態度。只要這個改動是對代碼庫的改進，你就應該尊重作者的意見，即更改表明了一些可以而且應該改進的地方。

寫出小的更改

’

要保持代碼審查過程的靈活性，最重要的做法可能是保持小的更改。理想情況下，代碼審查應該是容易理解的，並且對審查者和作者來說，都是集中在一個問題上。谷歌的代碼審查過程不鼓勵由完全成型的項目組成的大規模修改，審查員可以理所當然地拒絕這樣的更改，因爲它對於一次審查來說太大。較小的改動也可以防止工程師浪費時間等待對較大變更的審查，減少停滯時間。這些小更改在軟件開發過程中也有好處。如果一個特定的變更足夠小，那麼確定該變更中的錯誤來源就容易得多。

’

儘管如此，必須承認，依賴於小更改的代碼審查過程有時很難與主要新特性的引入相協調。一組小的、漸進式的代碼修改可能更容易單獨消化，但在一個更大的方案中卻更難理解。不可否認，谷歌的一些工程師並不喜歡小改動。存在管理這種代碼變化的技術（在集成分支上開發，使用不同於的管理變化），但這些技術不可避免地涉及更多的開銷。考慮到對小改動的優化只是一個優化，並允許你的過程適應偶爾的大更改。

”’

“小”改動一般應限制在行左右的代碼。一個小的更改應該對審查者來說是容易的，而且，幾乎同樣重要的是，不要太麻煩，以至於更多的更改被延遲，以等待廣泛的審查。在谷歌，大多數的更改預計會在一天內被審查。這並不一定意味着審查在一天內結束，但初步反饋會在一天內提供。在谷歌，大約的修改是針對單個文件的。對審查者來說容易，可以更快地修改代碼庫，對作者也有利。作者希望快速審查；等待一個星期左右的廣泛審查可能會影響後續的更改。一個小規模的初步審查也可以防止在後續的錯誤方法上浪費更昂貴的精力。

’’’

因爲代碼審查通常是小規模的，所以在谷歌，幾乎所有的代碼審查都是由一個人審查，而且只有一個人。如果不是這樣的話如果一個團隊被期望對一個共同的代碼庫的所有更改進行評估，那麼這個過程本身就沒有辦法擴展。通過保持小規模的代碼審查，我們實現了這種優化。多人對任何給定的更改發表評論的情況並不罕見大多數代碼審查被髮送給一個團隊成員，但也被抄送給適當的團隊但主要的審查員仍然是那個希望得到的人，而且對於任何給定的更改，只有一個是必要的。任何其他評論，儘管很重要，但仍然是可選的。

“”

保持小的更改也允許批准審查員更快地批准任何特定的變化。他們可以快速檢查主要的代碼審查員是否盡職盡責，並純粹關注這一變化是否增強了代碼庫，同時隨着時間的推移保持代碼的健康。

>“”>>、、、和，“現代代碼評論：谷歌的案例研究”>>>>同上。

寫出好的變更描述

變更描述應該在第一行標註它的變更類型，作爲一個摘要。第一行是最重要的，它被用來在代碼審查工具中提供摘要，作爲任何相關電子郵件的主題行，併成爲谷歌工程師在代碼搜索中看到的歷史摘要的可見行（見第章），所以第一行很重要。

“”

雖然第一行應該是整個更改的摘要，但描述仍然應該詳細說明更改的內容和原因。“修復”的描述對審查員或未來的代碼考古學家來說是沒有幫助的。如果在變更中進行了多個相關修改，請在列表中列出這些修改（同時仍保留信息和小信息）。描述是此更改的歷史記錄，代碼搜索等工具允許你查找誰在代碼庫中的任何特定更改中編寫了哪一行。在試圖修復時，深入瞭解原始更改通常很有用。

’’

描述並不是爲一個更改添加文檔的唯一機會。在編寫公共時，你通常不想泄露實現的細節，但在實際實現中，你應該隨意地進行註釋。如果審查員不理解你爲什麼要這樣做，即使它是正確的，這也是一個很好的指標，說明這樣的代碼需要更好的結構或更好的註釋（或兩者）。如果在代碼審查過程中，有了新的決定，請更新修改說明，或在實現中添加適當的註釋。代碼審查不僅僅是你當前所做的事情；這是你爲後繼者所做的記錄。

儘量減少審查員

在谷歌，大多數的代碼審查都是由一個審查員進行審查的。由於代碼審查過程允許由一個人處理代碼正確性、所有者接受度和語言可讀性等方面的問題，代碼審查過程在谷歌這樣的組織規模中具有相當好的擴展性。

’’

在行業內和個人都有一種趨勢，即試圖從工程師的各個方面獲得額外的投入（和一致同意）。畢竟，每個額外的審查員都可以爲所討論的代碼審閱添加他們自己的特定見解。但我們發現這會導致收益遞減；最重要的是第一個，後續的不會像你想象的那樣添加到等式中。額外審查員的成本很快就超過了他們的價值。

代碼審查過程是圍繞着我們對工程師的信任而優化的，他們會做正確的事情。在某些情況下，讓一個特定的更改由多人審查可能是有用的，但即使在這些情況下，這些審查員也應該專注於同一變化的不同方面。

>>>同上。

儘可能實現自動化

代碼評審是一個人工過程，人的投入很重要，但是如果代碼過程中的某些部分可以自動化，就儘量這樣做。應該探索將人類的機械任務自動化的機會；在適當的工具上的投資可以獲得回報。在谷歌，我們的代碼審查工具允許作者自動提交修改，並在批准後自動同步到源代碼控制系統（通常用於相當簡單的修改）。

在過去的幾年中，關於自動化的最重要的技術改進之一是對給定的代碼修改進行自動靜態分析（見第章）。目前的代碼審查工具並不要求作者運行測試、或格式化程序，而是通過所謂的預提交自動提供大部分的效用。預提交的過程是在一個更改最初被髮送給一個審查員時運行的。在該更改被髮送之前，預提交程序可以檢測到現有更改的各種問題，拒絕當前的更改（並防止向審查者發送尷尬的電子郵件），並要求原作者首先修復該更改。這樣的自動化不僅對代碼審查過程本身有幫助，還能讓審查員專注於比格式化更重要的問題。

代碼審查的類型

所有的代碼審查都是不一樣的不同類型的代碼審查需要對審查過程中的各個環節進行不同程度的關注。在谷歌，代碼變更一般都屬於以下幾種情況（儘管有時會有重疊）：

綠地審查和新功能開發行爲更改、改進和優化修復和回滾重構和大規模更改

綠地代碼審查

最不常見的代碼審查類型是全新的代碼，即所謂的綠地審查。綠地審查是評估代碼是否經得起時間考驗的最重要時機：隨着時間和規模的變化，代碼的基本假設也會發生變化，它將更容易維護。當然，引入全新的代碼並不令人驚訝。正如本章前面提到的，編碼是一種責任，因此引入全新的代碼通常應該解決一個真正的問題，而不僅僅是提供另一種選擇。在，除了代碼審查之外，我們一般要求新的代碼和或項目要經過廣泛的設計審查。代碼審查不是辯論過去已經做出的設計決定的時候（同樣的道理，代碼審查也不是介紹建議的的設計的時候）。

’

爲了確保代碼是可持續性，綠地審查應該確保與商定的設計相匹配（這可能需要審查設計文檔），並進行充分測試，所有端點都有某種形式的單元測試，而且當代碼的假設發生變化時，這些測試會失效。見第章）。代碼還應該有適當的所有者（一個新項目的第一次審查往往是對新目錄的一個單一的文件的審查），有足夠的註釋，如果需要的話，還應該提供補充文檔。綠地審查也可能需要將項目引入持續集成系統。參見第章）。

行爲更改、改進和優化

谷歌的大多數更改一般都屬於對代碼庫內現有代碼進行更改的類型。這些新增內容可能包括對端點的更改，對現有實現的改進，或對其他因素的優化，如性能。這類更改是大多數軟件工程師的日常。

在每一種情況下，適用於綠地審查的指南也適用：這種更改是否必要，以及這種更改是否改善了代碼庫？對代碼庫的一些最佳更改實際上是刪除！消除死代碼或過時代碼是改善代碼庫整體代碼健康狀況的最佳方法之一。

’’

任何行爲修改都必須包括對任何新行爲的適當測試的修訂。應在持續集成（）系統中測試對實現的增強，以確保這些修改不會破壞現有測試的任何基本假設。此外，優化當然應該確保它們不會影響這些測試，並且可能需要包括性能基準，供審查員參考。一些優化可能還需要基準測試。

修復和回滾

不可避免地，你將需要提交一個更改以修復你的代碼庫中的。在這樣做的時候，要避免一起處理其他問題的誘惑。這不僅有可能增加代碼審查的規模，也會使執行迴歸測試或其他人回滾你的更改更加困難。修復應該只關注於修復指定的，並且（通常）更新相關的測試以捕獲最初發生的錯誤。

用修改後的測試來解決這個往往是必要的。這個的出現是因爲現有的測試不充分，或者代碼中的某些假設沒有被滿足。作爲一個修復的審查員，如果適用的話，要求更新單元測試是很重要的。

’“”

有時，像谷歌這樣龐大的代碼庫中的代碼變更會導致一些依賴失效，而這些依賴要麼沒有被測試正確地檢測到，要麼就是發現了代碼庫中未經測試的部分。在這些情況下，谷歌允許這種變化被回滾，通常是由受影響的下游客戶進行。回滾由基本上撤消先前更改的更改組成。這種回滾可以在幾秒鐘內創建，因爲它們只是將以前的更改恢復到已知狀態，但仍然需要代碼檢查。

’

同樣至關重要的是，任何可能導致潛在回滾的更改（這包括所有的變化！）都要儘可能小且原子化，這樣，如果需要回滾，就不會導致其他依賴關係的進一步破壞，從而難以解開。在谷歌，我們看到開發人員在提交新代碼後很快就開始依賴新代碼，而回滾有時會破壞這些開發人員。小更改有助於緩解這些擔憂，這既因爲它們的原子性，也因爲對小更改的審查往往很快完成。

重構和大規模更改

’

谷歌的許多變更是自動生成的：變更的作者不是人，而是機器。我們在第章中討論了更多關於大規模變更的過程，但即使是機器生成的變更也需要審查。在被認爲是低風險的情況下，它被指定的審查員審查，他們對我們的整個代碼庫有批准權。但對於那些可能有風險或需要本地領域專業知識的變化，個別工程師可能被要求審查自動生成的變化，作爲他們正常工作流程的一部分。

乍一看，對自動生成的變更的審查應與任何其他代碼審查一樣進行處理：審查員應檢查變更的正確性和適用性。但是，我們鼓勵審查員限制相關更改中的註釋，只標記特定於其代碼的關注點，而不是生成更改的底層工具或。雖然具體的變更可能是機器生成的，但生成這些變更的整個流程已經過審查，單個團隊不能對該流程擁有否決權，否則就不可能在整個組織中擴展此類變更。如果對基礎工具或流程存在擔憂，審查員可以將帶外問題上報給監督小組，以獲取更多信息。

我們還鼓勵自動更改的審查者避免擴大其範圍。當審查一項新功能或一項由團隊成員編寫的變更時，通常有理由要求作者解決同一變更中的相關問題，只要該請求仍然遵循先前的建議，以保持較小的變更。這不適用於自動生成的變更，因爲運行工具的人可能有數百個變更在進行，即使是帶有審查意見或無關問題的一小部分更改，也會限制人員有效操作該工具的範圍。

總結

代碼審查是谷歌最重要、最關鍵的流程之一。代碼評審充當着工程師之間的粘合劑，代碼評審過程是開發人員的主要工作流程，幾乎所有其他過程都必須依賴於此，從測試到靜態分析再到。代碼評審過程必須適當擴展，因此，最佳實踐（包括小變更、快速反饋和迭代）對於保持開發人員滿意度和適當的生產速度非常重要。

內容提要

代碼審查有很多好處，包括確保代碼的正確性、理解性和整個代碼庫的一致性。總是通過別人來檢查你的假設；爲讀者優化。在保持專業性同時提供關鍵反饋的機會。代碼審查對於整個組織的知識共享非常重要。自動化對於擴展這個過程是至關重要的。代碼審查本身提供了一個歷史記錄。