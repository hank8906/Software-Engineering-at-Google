’

第十九章體驗：的代碼審查工具

正如你在第章中所看到的，代碼審查是軟件開發的重要組成部分，特別是在大規模工作時。代碼審查的主要目標是提高代碼庫的可讀性和可維護性，評審過程從根本上支持這一點。然而，擁有一個定義明確的代碼審查過程只是代碼審查流程的一個部分。支持該過程的工具在其成功中也起着重要作用。

’’“”

在本章中，我們將通過深受喜愛的內部系統，來看看成功的代碼審查工具的模樣。明確支持代碼審查的主要功能，爲審查者和作者提供審查的視圖和對更改的評論能力。還支持對哪些代碼被檢入代碼庫進行把關，這一點在評分更改一節中討論。評論中的代碼評審信息在進行代碼考古時也很有用，遵循代碼評審交互中解釋的一些技術決策（例如，當缺少內聯註釋時）。儘管並不是唯一使用的代碼審查工具，但它是最受歡迎的工具。

代碼審查工具原則

’

’

我們在前面提到，提供了支持代碼審查目標的功能（我們在本章後面會詳細介紹這種功能），但爲什麼它如此成功？是基於的開發文化塑造的，其中包括代碼審查作爲工作流程的核心部分。這種文化影響轉化爲一套指導原則，的設計就是爲了強調這些原則：

簡潔性的用戶界面（）基於使代碼審查變得容易而不需要很多不必要的選擇，並且具有流暢界面。用戶界面加載速度快，導航簡單，支持熱鍵，而且有清晰的視覺標記，可以顯示更改是否已審覈的總體狀態。信任的基礎代碼審查不是爲了拖慢別人，相反，它是爲了授權他人。儘可能地信任同事使其發揮作用。這可能意味着，例如，信任作者進行更改，而不需要額外的審查階段來再次檢查是否確實解決了次要評論。信任還體現在使修改在整個谷歌上公開進行（供查看和審查）。通用的溝通溝通問題很難通過工具來解決。優先考慮讓用戶對代碼修改進行評論的通用方法，而不是複雜的協定。評論鼓勵用戶詳細說明他們想要的內容，甚至建議進行一些編輯，而不是使數據模型和過程更加複雜。即使是最好的代碼審查工具，溝通也會出錯，因爲用戶是人。工作流程的集成有很多與其他核心軟件開發工具的集成點。開發人員可以在我們的代碼搜索和瀏覽工具中輕鬆瀏覽正在審查的代碼，在我們基於網絡的代碼編輯工具中編輯代碼，或者查看與代碼修改相關的測試結果。

在這些指導原則中，簡單性可能對這個工具影響最大。我們考慮過增加許多有趣的功能，但我們決定不爲支持一小部分用戶而使模型更加複雜。

“”

簡單與工作流程的整合也有一個有趣的矛盾。我們考慮過，但最終決定不創建一個集代碼編輯、審查和搜索於一體的代碼中心工具。儘管與其他工具有許多接觸點，但我們還是有意識地決定將代碼審查作爲主要關注點。特徵與評論相關，但在不同的子系統中實施。

代碼審查流程

’

代碼審查可以在軟件開發的許多階段進行，如圖所示。評論評審通常在變更提交到代碼庫之前進行，也稱爲預提交評審。儘管第章包含了對代碼評審流程的簡要描述，但在這裏我們將其擴展，以描述在每個階段的關鍵作用。我們將在下面的章節中更詳細地討論每個階段。

“”“”’“”’

典型的審查步驟如下：

創建一個變更。一個用戶對其工作區的代碼庫進行變更。然後這個作者向上傳一個快照（顯示某一特定時間點的補丁），這將觸發自動代碼分析器的運行（見第章）。要求審查。在作者對修改的差異和中顯示的分析器的結果感到滿意後，他們將修改發送給一個或多個審查員。評論。評論者在中打開修改，並對起草評論。評論默認標記爲未解決，意味着它們對作者來說是至關重要的。此外，評論者可以添加已解決的評論，這些評論是可選的或信息性的。自動代碼分析器的結果，如果存在的話，也可以讓審查者看到。一旦審查者起草了一組評論，他們需要發佈它們，以便作者看到它們；這樣做的好處是允許審查者在審查了整個修改後，以原子方式提供一個完整的想法。任何人都可以對變更發表評論，並在他們認爲必要時提供“驅動式審查”。修改變更並回複評論。作者修改變更，根據反饋上傳新的快照，並回複評論者。作者處理（至少）所有未解決的評論，要麼修改代碼，要麼直接回複評論並將評論類型改爲解決。作者和審稿人可以查看任何一對快照之間的差異，看看有什麼變化。步驟和可能要重複多次。變更批准。當審查者對修改的最新狀態感到滿意時，他們會批准變更，並將其標記爲“我覺得不錯（）。他們可以選擇包含已解決的評論。更改被認爲適合提交後，在中會清楚地標記爲綠色以顯示此狀態。提交變更。只要變更被批准（我們很快會討論），作者就可以觸發變更的提交過程。如果自動分析器和其他預提交鉤子（稱爲預提交）沒有發現任何問題，該變更就被提交到代碼庫中。

即使在審查過程開始後，整個系統也提供了很大的靈活性來偏離常規的審查流程。例如，評審員可以取消自己對修改的分配，或者明確地將其分配給其他人，而作者可以完全推遲評審。在緊急情況下，作者可以強行提交他們的修改，並在提交後對其進行審查。

通知

當一個變更經過前面概述的階段時，會發布可能被其他支持工具使用的事件通知。這種通知模式使能夠專注於成爲一個主要的代碼審查工具，而不是一個通用的工具，同時仍然能夠集成到開發人員的工作流程中。通知實現了關注點的分離，這樣就可以直接發出事件，而其他系統則基於這些事件進行開發。

’

例如，用戶可以安裝使用這些事件通知的擴展。當一個變更需要用戶注意時例如，當更改需要用戶注意時，由於輪到用戶查看更改或某個預提交失敗該擴展會顯示一個通知，其中有一個按鈕可直接轉到更改或使通知靜默。我們發現，一些開發者非常喜歡即時的變更更新通知，但也有人選擇不使用這個擴展，因爲他們覺得這對他們的工作流程太過干擾。

’

還管理與變化有關的電子郵件；重要的事件會觸發電子郵件通知。除了在中顯示外，一些分析器的結果也被配置爲通過電子郵件發送。還處理電子郵件回覆並將其轉換爲評論，支持喜歡基於電子郵件的流程的用戶。請注意，對許多用戶來說，電子郵件並不是代碼審查的一個關鍵特徵；他們使用的儀表盤視圖（後面會討論）來管理評論。

階段：創建一個變更

代碼審查工具應該在審查過程的各個階段提供支持，不應該成爲提交更改的瓶頸。在審查前的步驟中，讓修改者在送出審查前更容易打磨修正，有助於減少審查者檢查修改的時間。在顯示修改差異時，可以忽略空白處的修改，並突出顯示純移動的修改。還可以顯示構建、測試和靜態分析器的結果，包括樣式檢查（如第章中所討論的）。

向作者展示修改的差異，讓他們有機會擁有不同的思路：代碼審查者的思路。可以讓更改作者像他們的審查者一樣看到他們的更改的差異，也可以看到自動分析的結果。還支持在審查工具中對變更進行輕量級的更改，並推薦合適的審查者。在發送請求時，作者也可以包括對修改的初步評論，提供機會直接向審查者詢問任何公開的問題。讓作者有機會像他們的審查者一樣看到一個變化，可以防止誤解。

爲了給審閱者提供進一步的上下文，作者還可以將更改鏈接到特定的。評論使用自動完成服務來顯示相關的，並對分配給作者的進行優先級排序。

差異點

代碼審查過程的核心是理解代碼變更本身。較大的變化通常比小的變化更難理解。因此，優化變更的差異是一個好的代碼審查工具的核心要求。

在中，這一原則轉化爲多個層面（見圖）。從優化的最長共同子序列算法開始，組件得到了以下增強：

語法高亮交叉引用（由提供，見第章）字符內差分，顯示字符級的差異，並考慮到詞的邊界（圖）。在不同程度上忽略空白差異的選項。移動檢測，在這種檢測中，從一個地方移動到另一個地方的代碼塊被標記爲正在移動（而不是像樸素的算法那樣，在這裏被標記爲刪除，在那裏被添加）。

’

用戶還可以以各種不同的模式查看，如疊加和並排。在開發時，我們決定必須有並排的，使審查過程更容易。並排需要很大的空間：爲了使它們成爲現實，我們必須簡化視圖結構，因此沒有邊框，沒有填充，只有和行號。我們還不得不使用各種字體和尺寸，直到我們有了一種差異視圖，即使是在啓動時典型的屏幕寬度分辨率（像素）下，也能滿足的個字符行數限制。

還支持各種定製工具，這些工具提供由變更產生的構件，例如由變更修改的屏幕截圖差異或由變更生成的配置文件。

爲了使瀏覽的過程順利進行，我們小心翼翼地避免浪費空間，並花費大量精力確保加載迅速，即使是圖片和大文件和或更改。我們還提供快捷鍵，以便在僅訪問更改的部分時快速瀏覽文件。

當用戶深入到文件層面時，提供了一個小工具，緊湊地顯示了文件的快照版本鏈；用戶可以通過拖放來選擇要比較的版本。這個小組件會自動摺疊相似的快照，將注意力集中在重要的快照上。它幫助用戶理解文件在變更中的演變；例如，哪些快照有測試覆蓋率，已經被審查過，或者有評論。爲了解決規模問題，預取了所有內容，所以加載不同的快照非常快。

分析結果

上傳變更的快照會觸發代碼分析器（見第章）。將分析結果顯示在變更頁面上，按分析器狀態籌碼彙總，顯示在變更描述下面，如圖所示，並在分析標籤中詳細說明，如圖所示。

“”

分析器可以標記特定的結果，以紅色突出顯示，以提高可視性。仍在進行中的分析器由黃色卡片表示，否則顯示灰色卡片。爲了簡單起見，沒有提供其他選項來標記或突出研究結果可操作性是一個二元選項。如果一個分析器產生了一些結果（研究結果），點擊卡片就可以打開研究結果。像評論一樣，研究結果可以顯示在裏面，但風格不同，使它們容易區分。有時，研究結果也包括修正建議，作者可以預先查看這些建議，並從評論中選擇應用。

例如，假設一個人發現行末有多餘的空格，是違反風格的。更改頁面將顯示該的卡片。從卡片中，作者可以快速轉到顯示違規代碼的，只需點擊兩次就能瞭解樣式違規。大多數違規的也包括修復建議。通過點擊，作者可以預覽修正建議（例如，刪除多餘的空格），並通過另一次點擊，在修改中應用修正。

緊密的工具集成

谷歌擁有建立在其單體源代碼庫（見第章）之上的工具，例如以下這些

，用於編輯雲中存儲的源代碼的在線代碼搜索，用於在代碼庫中搜索代碼的工具，用於顯示靜態分析結果的工具（前面提到），一個打包和部署包含一系列更改的二進制文件的發佈工具，一個測試覆蓋率計算工具

’

此外，還有一些服務可以提供變更元數據的上下文（例如，關於參與變更的用戶或鏈接的錯誤）。是一個很自然的熔爐，它可以快速地一鍵懸停訪問這些系統，甚至支持嵌入式，儘管我們需要小心不要犧牲簡單性。例如，在的更改頁面上，作者只需要點擊一次就可以在中進一步編輯修改。我們支持使用在交叉引用之間進行導航，或在代碼搜索中查看代碼的主線狀態（見第章）。鏈接到發佈工具，這樣用戶就可以看到提交的變更是否在一個特定的版本中。對於這些工具，更傾向於鏈接而不是嵌入，這樣就不會分散對核心評審經驗的注意力。這裏的一個例外是測試覆蓋率：測試是否覆蓋代碼行的信息由文件的視圖中的行槽上的不同背景色顯示（並非所有項目都使用此覆蓋率工具）。

’’

請注意，和開發者的工作空間之間的緊密結合是可能的，因爲工作空間存儲在一個基於的文件系統中，可以在特定開發者的計算機之外訪問。真相之源託管在雲中，所有這些工具都可以訪問。

階段：發送審查

在作者對更改的狀態感到滿意後，他們可以把它送去審查，如圖中所描述的。這需要作者挑選審查者。在一個小團隊內，尋找審查者可能看起來很簡單，但是即使在團隊成員之間均勻地分配評論，也需要考慮像是誰休假的情況。爲了解決這個問題，團隊可以爲收到的代碼審查提供一個電子郵件別名。這個別名被一個叫做的工具所使用（以最初使用這種技術的團隊命名：（谷歌網絡服務器），它根據鏈接到別名的配置分配特定的審閱者。例如，變更作者可以將評審分配給某個團隊列表別名，將選擇某個團隊列表別名的特定成員來執行評審。

’

考慮到谷歌代碼庫的規模和修改代碼的人數，很難找出誰最有資格審查你自己項目之外的變更。發現審查者在達到一定的規模時要考慮的問題。評論必須處理規模問題。提供了建議一組足以批准更改的審閱者的功能。評審員的選擇工具考慮到了以下因素

誰擁有被修改的代碼（見下一節）誰對該代碼最熟悉（即，誰最近修改過該代碼）。誰可以進行審查（即不脫產，最好在同一時區）。團隊的別名設置

“”

爲一個變更指定一個審查員會觸發一個審查請求。該請求運行適用於該變更的預提交或預提交鉤子；團隊可以以多種方式配置與他們的項目相關的預提交。最常見的鉤子包括以下內容：

自動將電子郵件列表添加到更改中，以提高意識和透明度爲項目運行自動化測試套件對代碼（強制執行本地代碼風格限制）和變更描述（允許生成發佈說明或其他形式的跟蹤）執行項目特定的不變因素

由於運行測試是資源密集型的，在，它們是預提交的一部分（在請求審查和提交修改時運行），而不是像檢查那樣爲每個快照運行。以類似於分析器結果的方式顯示運行鉤子的結果，並有一個額外的區別，即失敗的結果會阻止修改被送審或提交。如果預提交失敗，會通過電子郵件通知作者。

階段和：理解和評論變更

審查過程開始後，作者和審查員協同工作，以達到提交高質量變更的目標。

評論

發表評論是用戶在查看修改後的第二常見的行爲（圖）。評論中的評論對所有人都是公開的。任何人不僅僅是修改作者和指定的評審者都可以對更改進行評論。

“”

評論還提供了通過個人狀態跟蹤審查進度的能力。審閱者有複選框將最新快照中的單個文件標記爲已審閱，以幫助審閱者跟蹤他們已查看的內容。當作者修改文件時，所有審閱者都會清除該文件的“審閱”複選框，因爲最新快照已更新。

“”

當審查者看到一個相關的分析器發現時，他們可以點擊請修復按鈕，創建一個未解決的評論，要求作者解決這個問題。審查者還可以通過內聯編輯文件的最新版本來建議修改。將此建議轉換爲評論，並附上一個作者可以應用的修復程序。

“”’“”

沒有規定用戶應該創建什麼評論，但對於一些常見的評論，提供了快速的快捷方式。修改者可以點擊評論面板上的完成按鈕，以表示審查者的評論已被解決，或者點擊按鈕，以確認評論已被閱讀，通常用於信息性或選擇性評論。如果標註的評論未被解決，兩者都有解決的效果。這些快捷方式簡化了工作流程，減少了回覆評論所需的時間。

“”

如前所述，評論是隨心所欲地起草的，但隨後以原子方式發表，如圖所示。這允許作者和審查者在發送評論之前確保他們對自己的評論感到滿意。

瞭解變化的狀態

提供了一些機制，使人們清楚地瞭解到某項修改目前處於評論和迭代階段的什麼位置。這些機制包括確定誰需要採取下一步行動的功能，以及特定開發者參與的所有修改的審查作者狀態的儀表盤視圖。

“”“輪到誰”功能

’

加快審查過程的一個重要因素是瞭解什麼時候輪到你幹活了，特別是當有多個審查員被分配到一個變更時。如果作者想讓軟件工程師和負責該功能的用戶體驗人員審查他們的變更，或者爲服務準備部署的人員審查其更改，可能就是這種情況。通過管理每個變更的關注集，評論有助於確定下一個變更的關注者。

關注集由當前阻止更改的一組人組成。當評論者或作者在關注集中時，他們應該及時作出回應。自動化地在用戶發表評論時更新關注集，但用戶也可以自己管理關注集。當變化中的評論者較多時，它的作用就更大了。在中，關注集是通過將相關的用戶名用黑體字顯示出來的。

’

在我們實施這一功能後，我們的用戶很難想象以前的狀態。普遍的看法是：如果沒有這個，我們是怎麼過的？在我們實施這個功能之前，另一個選擇是審查員和作者之間的聊天，以瞭解誰在處理一個變化。這個功能也強調了代碼審查的輪流性質；總是至少輪到一個人採取行動。

儀表板和搜索系統

’’

的登陸頁面是用戶的儀表盤頁面，如圖所示。儀表盤頁面被分爲用戶可定製的部分，每個部分都包含一個變更摘要列表。

儀表板頁面是由一個名爲的搜索系統提供的。索引了谷歌所有用戶的所有可用變化的最新狀態（包括提交前和提交後），並允許其用戶通過基於正則表達式的查詢來查找相關變化。每個儀表板部分都由對的查詢來定義。我們花了很多時間來確保搜索足夠快；所有的東西都被快速索引，這樣作者和審稿人就不會被拖慢，儘管事實上谷歌同時出現了大量的併發更改。

’’

爲了優化用戶體驗（），的默認儀表盤設置是在第一部分顯示需要用戶關注的變更，不過這也是可以定製的。還有一個搜索欄，可以對所有修改進行自定義查詢，並瀏覽結果。作爲一個審查員，你主要是需要關注的一組。作爲一個作者，你大多數時候只需要看一下哪些東西還在等待審查，看看你是否需要修正。儘管我們在用戶界面的一些其他部分迴避了可定製性，但我們發現用戶喜歡以不同的方式設置他們的儀表板，而不影響基本的體驗，就像每個人以不同的方式組織他們的電子郵件一樣。

>“”>>大規模變更（）的集中式全球審查員特別容易定製這個儀表盤，以避免在期間淹沒它（見第章）。

階段：變更批准（對變更進行評分）

“”

“”

顯示一個審查員是否認爲一個變更是好的，歸根結底是通過評論提供關注和建議。此外，還需要有一些機制來提供一個高水平的。在谷歌，對一個變化的打分分爲三個部分：

（“我覺得不錯”）批准未解決的評論的數量

“”“”

審查者的印章意味着我已經審閱了這個變更，相信它符合我們的標準，我認爲在解決了未解決的評論之後，可以提交它。審查者的批准標識意味着作爲一個把關人，我允許這個修改被提交到代碼庫中。審查者可以將評論標記爲未解決，這意味着作者需要對其採取行動。當變更至少有一個、足夠的批准和沒有未解決的評論時，作者可以提交變更。請注意，無論批准狀態如何，每項變更都需要一個，以確保至少有兩雙眼睛查看該變更。這個簡單的評分規則使可以在修改準備好提交時通知作者（以綠色頁眉的形式突出顯示）。

“”“”

在建立的過程中，我們有意識地決定簡化這一評分方案。最初，有一個需要更多工作的評級，也有一個。我們所採用的模式是使批准總是積極的。如果變更確實需要第二次審覈，主要審查者可以添加內容，但無需批准。在一個變化過渡到基本良好的狀態後，審查員通常會相信作者會處理好小的編輯無論變更大小如何，該工具都不需要重複。

“”

這種評分方案也對代碼審查文化產生了積極影響。審查者不能在沒有任何有用反饋的情況下對一個改動豎起大拇指；所有來自審查者的負面反饋都必須與需要修復的具體內容相聯繫（例如，一個未解決的評論）。選擇未解決的評論這一措辭也是爲了聽起來比較好。

’

批評包括一個打分板，在分析卡片旁邊，有以下信息

誰進行了變更還需要哪些批准，爲什麼？有多少的評論仍未解決

以這種方式呈現評分信息有助於作者快速瞭解他們仍然需要做些什麼才能實現更改。

“”

和批准是硬性要求，只能由審查者授予。在提交變更之前，審查者還可以隨時撤銷其和批准。未解決的評論是軟性要求；作者可以在回覆時將評論標記爲已解決。這種區別促進並依賴於作者和審查者之間的信任和溝通。例如，審查者可以在的修改中伴隨着未解決的評論，而不需要後來精確地檢查這些評論是否真正被解決，這突出了審稿人對作者的信任。當作者和審稿人之間存在明顯的時區差異時，這種信任對於節省時間尤爲重要。展現信任也是建立信任和加強團隊的一個好方法。

階段：提交變更

最後但並非最不重要的是，有一個在審查後提交修改的按鈕，以避免上下文切換到命令行界面。

提交後：跟蹤歷史記錄

除了的核心用途是在源代碼修改提交到版本庫之前對其進行審查外，還被用作變更考古的工具。對於大多數文件，開發者可以在代碼搜索系統中查看過去修改某個文件的歷史列表（見第章），或者直接導航到某個修改。的任何人都可以瀏覽一般可查看文件的修改歷史，包括對修改的評論和演變。這使未來的審計成爲可能，並被用來了解更多的細節，如爲什麼會做出改變或如何引入。開發人員也可以使用這個功能來了解變化是如何被設計的，代碼審查數據的彙總被用來製作培訓。

還支持在修改提交後進行評論的能力；例如，當後來發現問題或額外的背景可能對另一個時間調查修改的人有用。還支持回滾修改的能力，以及查看某一修改是否已經被回滾。

案例研究：

’’

儘管是最常用的審查工具，但它並不是唯一的工具。由於與我們的大型單體庫和其他內部工具有緊密的相互依賴關係，所以不能對外使用。正因爲如此，在谷歌從事開源項目（包括和）或內部項目的團隊，如果不能或不想託管在單片庫中，就會使用另一種代碼審查工具：。

是一個獨立的開源代碼審查工具，與版本控制系統緊密集成。因此，它爲許多特性提供了一個，包括代碼瀏覽、合併分支、提交，當然還有代碼審查。此外，有一個細粒度的權限模型，我們可以使用它來限制對存儲庫和分支的訪問。

’

和都有相同的代碼評審模型，每個提交都是單獨評審的。支持堆疊提交併將其上載以供個人審閱。它還允許在對鏈進行審查後以原子方式提交鏈

’

由於是開源的，適應了更多的變體和更廣泛的用例；豐富的插件系統實現了與定製環境的緊密集成。爲了支持這些用例，還支持更復雜的評分系統。評審員可以通過給分否決變更，評分系統是高度可配置的。

你可以在瞭解更多關於的信息，並看到它的運行情況。

總結

在使用代碼審查工具時，有一些隱含的權衡因素。內置了許多功能，並與其他工具集成，使用戶的審查過程更加完美。花在代碼評審上的時間並不是比花在編碼上的時間少多少，所以評審過程的任何優化都可以提高公司的生產效率。在大多數情況下，只有兩個人（作者和審查者）在提交修改前達成一致，可以保持高速度。谷歌非常重視代碼審查的培訓方面，儘管它們更難以量化。

爲了最大限度地減少評審更改所需的時間，代碼評審過程應該無縫流動，簡潔地告知用戶需要關注的更改，並在人工評審員介入之前確定潛在問題（問題由分析人員和持續集成人員發現）。如果可能，在較長時間運行的分析完成之前，會顯示快速分析結果。

需要在幾個方面支持規模問題。工具必須在不降低性能的情況下，適應大量的審查請求。由於是在提交修改的關鍵路徑上，它必須有效地加載，並能在特殊情況下使用，如異常大的修改。界面必須支持在大型代碼庫中管理用戶活動（如尋找相關修改），並幫助評審員和作者瀏覽代碼庫。例如，有助於爲某一變更找到合適的審查者，而不必弄清所有權維護者的情況（這一功能對於大規模的變更，如可能影響許多文件的遷移，尤爲重要）。

傾向於採用意見一致的流程和簡單的界面來改善一般的審查工作流程。然而，確實允許一些自定義功能：自定義分析器和預提交提供了具體的修改內容，而且可以強制執行一些特定的團隊策略（如要求多個審稿人提供）。

>>>儘管大多數改動都很小（少於行），但有時也被用來審查大型的重構改動，這些改動可能會觸及成百上千個文件，特別是對於那些必須原子化執行的（見第章）。

’’

信任和溝通是代碼審查過程的核心。工具可以增強體驗，但不能替代它們。與其他工具的緊密結合也是成功的一個關鍵因素。

內容提要

’“”

信任和溝通是代碼審查過程的核心。工具可以增強體驗，但不能替代它們。與其他工具的緊密集成是獲得優秀代碼審查體驗的關鍵。小的工作流程優化，如增加一個明確的關注集，可以提高清晰度並大大減少摩擦。