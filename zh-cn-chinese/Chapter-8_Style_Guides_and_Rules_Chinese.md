第八章風格指導和規則

大多數軟件工程機構都有管理其代碼庫的規則關於源文件的存儲位置、代碼格式化規則、命名規則和模式以及異常和線程。大多數軟件工程師就在這組控制他們如何運作的策略的範圍內工作。在谷歌，要管理我們的代碼庫，我們維護了一套風格指南來定義我們的規則。

規則就像法律。它們不僅僅是建議或提議，而是嚴格的、強制性的法律。因此，規則具有普遍可執行性不得無視規則除非在需要使用的基礎上獲得豁免。與規則相反，指導提供幫助建議和最佳實踐。指導值得遵循，甚至是高度建議能夠遵守，但與規則不同的是，指導通常允許出現一些變化的空間。

’’“”’“”

我們把我們定義的規則，即寫代碼時必須遵守的做和不做，收集在我們的編程風格指南中，這些指南被視爲典範。“風格”可能這裏有點名不副實，暗示着範圍僅限於格式化實踐。我們的風格指南不止於此；它們是一套完整的約定約束我們的代碼。這並不是說我們的風格指南是嚴格規定的；是指導還是規則可能需要判斷，例如有一條命名規則是“在合理範圍內使用與描述性相同的名稱。”並且，我們的風格指南是最終的來源我們的工程師必須遵守的規則。

’’

我們爲每一門在谷歌使用的編程語言都單獨維護一套代碼風格指南。在高層次上，所有指南都有相似的目標，旨在引導代碼開發並着眼於可持續性。同時，也有很多變化其中包括範圍、長度和內容。編程語言有不同的優勢，不同的特點，不同的重點，以及在谷歌不斷發展的代碼庫中採用的不同歷史路徑。因此，獨立定製每種語言的指南要實際得多。我們的一部分風格指南注重簡潔，專注於一些總體原則，如命名和格式，如在我們的、和指南中進行演示的樣子。另一部分風格指南注重更多細節方面，深入研究特定的語言特徵並擴展內容，特別是我們的、和指南。還有一部分風格指南重視該語言在谷歌之外的慣例我們的風格指南非常簡短，只是在一個總結指令中添加了一些規則，以遵循外部公認的慣例。也有部分指南的規則和外部規範根本不同；我們的風格指南中不允許使用異常，而使用異常是一種在代碼之外廣泛使用語言特性。

’’’

即使是我們自己的風格指南也存在很大的差異，這使得我們很難精確地描述一個風格指南應該涵蓋什麼內容。指導谷歌風格指南開發的決定源於保持我們代碼庫可持續性的需要。其他組織的代碼庫天生對可持續性有不同的要求，這就需要一套不同的定製規則。本章討論了指導我們規則和指南開發的原則和過程，主要從谷歌的、和風格指南中抽取示例。

>>>我們的許多風格指南都有外部版本，你可以在。我們在本章中引用了這些指南中的許多例子。

爲什麼需要規則？

“”“”“”“”“”“”“”

那麼我們爲什麼需要規則呢制定規則的目的是鼓勵“好的”行爲，阻止“壞的”行爲。對“好”和“壞”的解釋因組織而異，這取決於組織關心的是什麼。這樣的設計不是普遍的偏好好與壞是主觀的，是根據需要而定的。對於一些組織，“好”可能會促進支持小內存佔用或優先考慮潛在運行時優化的使用模式。在其他組織中，“好”可能促進使用新語言特性的選擇。有時，組織非常關心一致性，因此與現有模式不一致的任何東西都是“不好的”。我們必須首先認識到一個給定的組織的價值我們使用規則和指導來鼓勵和阻止相應的行爲。

’“”

隨着組織的發展，已建立的規則和指導方針形成了通用的編碼詞彙表。通用詞彙表可以讓工程師專注於他們的代碼需要表達什麼，而不是如何表達。通過塑造這種詞彙，工程師會傾向於默認地、甚至是潛意識地去做“好”事情。因此，規則爲我們提供了廣泛的槓桿作用，以便將共同的開發模式推向所需的方向。

創建規則

“”“”“”“”

當定義一組規則時，關鍵問題不是“我們應該有什麼規則”我們要問的問題是“我們想要實現的目標是什麼”當我們關注規則將服務的目標時，識別哪些規則支持這個目標，可以更容易地提取有用的規則集。在谷歌，風格指南作爲編碼實踐的法規，我們不會問，“風格指南中包含什麼”而是“爲什麼要把一些東西放進風格指南”我們的組織通過制定一套規範代碼編寫的規則獲得了什麼

指導原則

’’’

讓我們把事情放在背景中谷歌的工程組織由萬多名工程師組成。工程師羣體在技能和背景方面表現出巨大的差異。每天大約有萬份文件提交給超過億行代碼的代碼庫，這些代碼庫可能會存在幾十年。我們正在優化一套不同於大多數其他組織所需要的價值，但在某種程度上，這些關注是無處不在的我們需要維持一個對規模和時間都有擴展的工程環境。

在這種情況下，我們規則的目標是管理開發環境的複雜性，保持代碼庫的可管理性，同時仍然允許工程師高效地工作。我們在這裏做了權衡幫助我們實現這一目標的大量規則確實意味着我們在限制選擇。我們失去了一些靈活性，甚至可能會冒犯某些人，但權威標準所帶來的一致性和減少衝突的收益是最重要的。

鑑於這一觀點，我們認識到一些指導我們制定規則的首要原則，這些原則必須

發揮其作用爲讀者優化保持一致避免容易出錯和令人驚訝的結構必要時對實際問題讓步

規則必須發揮其作用

並不是所有的東西都應該放在風格指南中。要求組織中的所有工程師學習和適應任何新規則的成本是有一定代價的。有太多的規則，不僅會讓工程師在寫代碼時更難記住所有相關的規則，而且也會讓新工程師更難學會他們的方法。更多的規則也會使維護規則集更具挑戰性和更昂貴。

’’’’

爲此，我們有意排除了大家公認的不言而喻的規則。谷歌的風格指南不打算以法律的方式解釋沒有明確規定的東西並不意味着它是合法的。例如，風格指南沒有規定禁止使用。程序員已經傾向於避免使用它，所以包含禁止使用它的顯式規則將引入不必要的開銷。如果只有一兩個工程師犯了錯誤，那麼通過創建新規則來增加每個人的負擔是不利於以後擴展的。

>“”’’>>這裏的工具很重要。衡量太多的標準不是規則的初始數量，而是一個工程師需要記住多少規則。例如，在之前的糟糕時代，我們需要記住大量的格式化規則。這些規則並沒有消失，但在我們目前的工具中，遵守規則的成本已經大大降低了。我們已經達到了這樣的程度：任何人都可以添加任意數量的格式化規則，而沒有人會在意，因爲工具只是爲你處理好。

爲讀者優化

’“”“”’

我們規則的另一個原則是爲代碼的讀者而不是作者優化。隨着時間的推移，我們的代碼被閱讀的頻率將遠遠高於編寫的頻率。我們寧願代碼是繁瑣的輸入，而不是難以閱讀。在我們的風格指南中，當討論條件表達式時，我們認識到它們比語句短，因此對代碼作者來說更方便。然而，由於它們往往比更冗長的語句更難讓讀者理解，所以我們限制了它們的使用。我們認爲“讀起來簡單”比“寫起來簡單”更重要。我們在這裏做了一個權衡當工程師必須重複地爲變量和類型輸入可能更長的描述性名稱時，前期的成本會更高。我們選擇支付這筆費用，是因爲它爲所有未來的讀者提供了可讀性。

作爲優先級的一部分，我們還要求工程師在他們的代碼中留下預期行爲的明確證明。我們希望讀者在閱讀代碼時能夠清楚地理解代碼在做什麼。例如，我們的、和風格指導在方法重寫超類方法時手動使用註釋或關鍵字。如果沒有明確的設計證明，讀者很可能會發現這一意圖，但是這需要每個閱讀代碼的讀者對代碼進行更多的挖掘。

’

這可能令人驚訝，有意行爲的證明變得更加重要。在中，僅僅通過閱讀一段代碼，有時很難追蹤指針的所有權。如果一個指針被傳遞給一個函數，在不熟悉該函數的行爲的情況下，我們不能確定將會發生什麼。調用者仍然擁有指針嗎這個函數擁有所有權了嗎我可以在函數返回後繼續使用指針嗎或者它可能已經被刪除了爲了避免這個問題，我們的風格指南更傾向於使用來實現所有權轉移。是一個管理指針所有權的構造，確保指針只有一個副本存在。當函數接受一個作爲參數，並打算獲得指針的所有權時，調用者必須顯式地調用語義

’

將此與以下內容進行比較

<><><>

’’’

鑑於風格指南規則，我們保證所有調用方將包括明確的所有權轉移證明，無論何時適用。有了這個信號，代碼的讀者就不需要理解每個函數調用的行爲了。我們在中提供了足夠的信息來推斷它的交互。這種清晰的調用方行爲文檔確保了代碼片段的可讀性和可理解性。我們的目標是局部推理，目標是清楚地瞭解在調用方發生了什麼，而不需要查找和引用其他代碼，包括函數的具體實現。

大多數涉及註釋的風格指南規則也被設計成支持爲讀者提供原地證明的目標。文檔註釋預先掛在給定文件、類或函數上的塊註釋描述了後面代碼的設計或意圖。實現註釋註釋穿插在代碼本身中說明或突出不明顯的選擇，解釋棘手的部分，並強調代碼的重要部分。這兩種類型註釋的指導風格規則在指南中都有涵蓋，要求工程師提供其他工程師在閱讀代碼時可能正在尋找的解釋。

保持一致性

’’’

我們對代碼庫一致性的看法類似於我們應用於谷歌辦公室的理念。由於工程人員衆多，分佈廣泛，團隊經常被分到不同的辦公室，而且谷歌員工經常發現自己在其他地方出差。儘管每個辦公室都保留了自己獨特的個性，融入了當地的風味和風格，但爲了完成工作，有一些東西被刻意保持一致。來訪的谷歌員工的徽章可以工作在所有當地的徽章閱讀器上任何谷歌設備都可以使用任何一間會議室的視頻會議設置都將具有相同的界面。谷歌員工不需要花時間去學習如何設置這些他們知道，無論他們在哪裏，這個基本條件都是一樣的。在不同的辦公室之間轉換工作很容易，而且還能完成工作。

’

這就是我們在源代碼中所追求的。一致性是使任何工程師即使進入代碼庫中不熟悉的部分，也能夠相當迅速地開始工作的原因。一個本地項目可以有它獨特的個性，但是它的工具是一樣的，它的技術是一樣的，它的庫是一樣的，而且都是正常工作的。

一致性的優點

’

’’’’’’’’’

儘管不允許辦公室定製徽章閱讀器或視頻會議界面可能會讓人覺得受到限制，但一致性帶來的好處遠遠大於我們失去的創作自由。代碼也是如此一致性有時可能會讓人感到約束，但這意味着更多的工程師用更少的努力完成更多的工作編寫代碼的工程師和閱讀代碼的其他人就可以專注於正在完成的工作，而不是它的呈現方式。在很大程度上，這種一致性允許專家分塊閱讀。當我們用相同的界面解決問題，並以一致的方式格式化代碼時，專家們更容易瀏覽一些代碼，鎖定重要的內容，並理解它在做什麼。它還使模塊化代碼和定位重複變得更容易。基於這些原因，我們將重點放在一致的命名約定、一致的通用模式使用以及一致的格式和結構上。也有許多規則對看似很小的問題做出決定，只是爲了保證事情只能以一種方式完成。例如，選擇用於縮進的空格數或行長限制只有一個答案而不是答案本身的纔是這裏有價值的部分。一致性可以使規模擴大。工具是組織擴展的關鍵，而一致的代碼使構建能夠理解、編輯和生成代碼的工具變得更容易。如果每個人都有少量不同的代碼，那麼依賴於一致性的工具的全部好處就無法應用如果一個工具可以通過添加缺失的導入或刪除未使用的包含來更新源文件，如果不同的項目爲他們的導入列表選擇不同的排序策略，這個工具可能不能在任何地方都適用。當每個人都使用相同的組件，當每個人的代碼都遵循相同的結構和組織規則時，我們就可以投資於在任何地方都能工作的工具，爲我們的許多維護任務構建自動化。如果每個團隊需要分別投資同一工具的定製版本，爲他們獨特的環境量身定製，我們就會失去這種優勢。在擴展組織的人力部分時，一致性也有幫助。隨着組織的增長，從事代碼庫工作的工程師數量也會增加。讓每個人都在編寫的代碼儘可能一致，這樣可以更好地跨項目移動，最大限度地減少工程師轉換團隊的過渡時間，併爲組織構建適應員工需求波動的能力。一個成長中的組織還意味着其他角色的人與代碼、庫工程師和代碼管理員進行交互。在谷歌，這些角色通常跨越多個項目，這意味着不熟悉某個團隊項目的工程師可能會參與到項目代碼的編寫中。跨代碼庫的一致體驗使得這種方法非常有效。一致性也確保了對時間的適應性。隨着時間的推移，工程師離開項目，新人加入，所有權轉移，項目合併或分裂。努力實現一致的代碼庫可以確保這些轉換的成本較低，並允許我們對代碼和工作在代碼上的工程師幾乎不受約束的流動，從而簡化長期維護所需的過程。

>>>歸功於的現實世界的比較，這是在訪問了大約個不同的谷歌辦公室後做出的。>>“”“”>>分塊是一種認知過程，它將信息碎片組合成有意義的塊，而不是單獨記下它們。例如，國際象棋高手考慮的是棋子的配置，而不是個人的位置。>>>>查閱

規模效應

“”

幾年前，我們的風格指南承諾，幾乎不會改變會使舊代碼不一致的風格指南規則“在某些情況下，改變某些風格規則可能有很好的理由，但我們仍然保持事物的原樣，以保持一致性。”

當代碼庫比較小的時候，老舊的代碼比較少的時候，這是有意義的。

當代碼庫變得更大、更老舊時，這就不再是需要優先考慮的事情了。這是至少對於我們風格指南背後的裁定者來說一個有意識的改變當改變這一點時，我們明確地聲明代碼庫將不再是完全一致的，我們甚至也不打算這樣做。

’’’’

不僅要將規則更新到當前的最佳實踐，而且還要將這些規則應用到已經編寫的所有內容，這樣的負擔太大了。我們的大規模變更工具和過程允許我們更新幾乎所有的代碼，以遵循幾乎每一個新的模式或語法，所以大多數舊的代碼都呈現出最新的被認可的風格見第章。然而，這種機制並不完美當代碼庫變得足夠大時，我們不能保證每一段舊代碼都能符合新的最佳實踐。對完美一致性的要求需要付出的價代價太大了。

’“”

設置標準。當我們提倡一致性時，我們傾向於關注內部一致性。有時，局部的慣例規則在整體慣例規則產生之前就已經出現了，因此調整一切來適應整體慣例規則是不合理的。在這種情況下，我們提倡一種層級的一致性“保持一致性”從局部開始，一個文件中的規範優先於一個團隊的規範，優先於更大的項目的規範，也優先於整個代碼庫的規範。事實上，風格指南包含了許多明確遵守局部慣例的規則，重視局部的一致性，而不是科學技術的選擇。

然而，對於一個組織來說，僅僅創建並遵守一套內部慣例是不夠的。有時，應考慮到外部環境的慣例。

>>>使用，例子。

空格的計算

’

谷歌的風格指南最初要求我們所有的代碼都採用雙空格縮進。外部社區使用的標準風格指南使用四空格縮進。我們早期的大部分開發都是直接支持我們的項目，而不是實際的應用程序。因此，我們選擇使用雙空格縮進，以與我們的代碼保持一致，代碼已經以這種方式格式化了。隨着時間的推移，我們發現這種理論並不成立。編寫代碼的工程師讀和寫其他代碼的頻率要比讀和寫代碼的頻率高得多。每次我們的工程師需要查找或引用外部代碼片段時，我們都要花費額外的精力。每次我們試圖將代碼片段輸出到開源時，我們都經歷了很多痛苦，花了很多時間來調和內部代碼和我們想要加入的外部世界之間的差異。

當一種基於的語言，設計於谷歌，作爲構建描述語言有了自己的風格指南時，我們選擇使用四間距縮進來與外界保持一致。

’’

如果慣例已經存在，那麼一個組織與外界保持一致通常是一個好主意。對於小的，獨立的，生命週期短的項目，它可能不會有什麼不同內部一致性比發生在項目有限範圍之外的任何事情都重要。一旦時間的推移和潛在的擴展性成爲要素，代碼與外部項目交互甚至最終與外部世界交互的可能性就會增加。從長遠來看，堅持被廣泛接受的標準可能會有回報。

>>>用實現的文件的樣式格式由應用。參見。

避免容易出錯和令人驚訝的結構

’

我們的風格指南限制了我們使用的語言中一些更令人驚訝、不尋常或棘手的結構的使用。複雜的特徵往往有一些乍一看並不明顯的細微缺陷。在沒有徹底瞭解其複雜性的情況下使用這些特性，很容易誤用它們並引入錯誤。即使現在的項目的工程師可以很好地理解這個結構，也不能保證未來的項目成員和維護者有同樣的理解。

這就是我們風格指南中避免使用反射等功能特性的原因。反射函數和允許用戶使用字符串訪問對象的屬性

現在，在這個例子中，一切看起來都很好。但是考慮一下這個

’’’’

當搜索代碼時，怎麼知道這裏訪問的是字段、和沒有給讀者留下明確的證明。你不容易看到，因此也不容易驗證哪些字符串用於訪問對象的屬性。如果不是從讀取這些值，而是從遠程過程調用請求消息或數據存儲讀取這些值，那會怎麼樣呢這種模糊化的代碼可能會導致一個嚴重的安全漏洞，一個很難被發現的漏洞，只需錯誤地驗證消息就可能發生。測試和驗證這樣的代碼也很困難。

’

的動態特性允許這樣的行爲，並且在非常有限的情況下，使用和是有效的。然而，在大多數情況下，它們只會造成混淆並引入錯誤。

’’

儘管這些高級語言特性可能完美地解決了知道如何利用它們的專家的問題，但強大的特性通常更難理解，而且沒有得到廣泛的應用。我們需要我們所有的工程師都能夠在代碼庫中操作，而不僅僅是專家。它不僅支持新手軟件工程師，而且對來說也要創建一個更好的環境如果在調試生產中斷，他們會跳入任何可疑的代碼，甚至包括一些用他們不熟練的語言編寫的代碼。我們更加重視易於理解和維護的簡化、直接的代碼。

爲實用性讓步

“”’

用拉爾夫·沃爾多·愛默生的話說“愚蠢的一致性是心胸狹隘的妖怪（爲渺小的政治家、哲學家和神學家所崇拜。一個偉大的靈魂與一致性毫無關係）”。在我們追求一致的、簡化的代碼庫時，我們不想盲目地忽略所有其他內容。我們知道風格指南中的一些規則會遇到需要例外的情況，這都是可以的。必要時，我們允許對可能與我們的規則相沖突的優化和和實際問題做出讓步。

性能很重要。有時，即使這意味着犧牲一致性或可讀性，適應性能優化也是有意義的。例如，儘管我們的風格指南禁止使用異常，但它包含了一條允許使用的規則，是一個與異常相關的語言說明符，可以觸發編譯器優化。

’’’

互操作性也很重要。爲特定的非部分而設計的代碼，如果爲其目標量身定做，可能會做得更好。例如，我們的風格指南有一個通用命名準則的例外，它允許對模仿標準庫功能的實體使用標準庫的風格。風格指南還允許對編程的豁免，在編程中，與平臺特性的兼容性需要使用多重繼承，這對其他情況的代碼來說都是明確禁止的。我們的和風格指南都明確指出，生成的代碼中，經常與項目之外的組件交互或依賴於這些組件的代碼不在本指南的範圍內。一致性是非常重要的；適應更是關鍵所在。

>’’>>見命名規則的例外情況。作爲一個例子，我們的開源庫對打算替代標準類型的類型使用了命名。參見中定義的類型。這些是對標準類型的實現，因此使用了標準所青睞的風格，而不是谷歌所青睞的形式。>>>>查閱生成的代碼：主要是豁免

風格指南

那麼，語言風格指南應該包含哪些內容呢所有的風格指南規則大致分爲三類

規避危險的規則執行最佳實踐的規則確保一致性的規則

規避危險

首先，我們的風格指南包括關於語言特性的規則，這些規則出於技術原因必須或不必須做。我們有關於如何使用靜態成員和變量的規則；關於使用表達式的規則異常處理規則；關於構建線程、訪問控制和類繼承的規則。我們涵蓋了要使用的語言特性和要避免的結構。我們列出了可以使用的標準詞彙類型以及用途。我們特別包括了關於難以使用和難以正確使用的規則一些語言特性具有微妙的使用模式，可能不直觀或不容易正確應用，會導致一些。對於指南中的每個規則，我們的目標是在描述所達成的決定時，解釋權衡過的利弊。這些決定（規則）大多是基於對時適應性的需要，或者支持和鼓勵可維護的語言使用。

執行最佳實踐

我們的風格指南還包括一些編寫源代碼的最佳實踐的規則。這些規則有助於保持代碼庫的健康和可維護性。例如，我們指定代碼作者必須在哪裏以及如何包含註釋。我們的註釋規則涵蓋了註釋的一般慣例，並擴展到包括必須包含代碼內文檔的特定情況在這些情況下，意圖並不總是明顯的，例如語句中的失敗，空的異常捕獲塊，以及模板元編程。我們還有詳細說明源文件結構的規則，概述了預期內容的組織。我們有關於命名的規則包、類、函數、變量的命名。所有這些規則都是爲了指導工程師採用更健康、更可持續的代碼的實踐。

我們的風格指南中實施的一些最佳實踐旨在使源代碼更具可讀性。許多格式規則都屬於這一類。我們的樣式指南指定了何時以及如何使用換行和水平空格，以提高可讀性。它們還包括行長度限制和大括號對齊。對於某些語言，我們通過使用自動格式化工具來滿足格式化要求的和的。逐項列出格式化需求的詳細列表，或者命名必須應用的工具，目標是相同的我們有一套一致的格式化規則，旨在提高我們所有代碼的可讀性。

’

我們的風格指南還包括對新的和尚未被很好理解的語言特性的限制。目的是在學習過程中，在一個功能的潛在缺陷周圍預先安裝安全圍欄。同時，在每個人都應用起來之前，限制使用讓我們有機會觀察，從我們觀察的例子中開發和提取最佳實踐的使用模式。對於這些新特性，在開始的時候，我們有時並不確定該如何給予適當的指導。隨着採用範圍的擴大，希望以不同方式使用新特性的工程師會與風格指南的所有者討論他們的例子，要求允許超出最初限制範圍的額外用例。通過觀察收到的豁免請求，我們瞭解了該特性是如何被使用的，並最終收集了足夠多的示例來總結好的實踐。在我們得到這些信息之後，我們可以回到限制性規則，並修改它以允許更廣泛的使用。

>>>查閱以及其中多種語言定義了一般的評論規則。

案例分析：介紹

當引入是一種智能指針類型，它表達了對動態分配對象的獨佔所有權，並在超出範圍時刪除該對象，我們的風格指南最初不允許使用。的使用方式對於大多數工程師來說是不熟悉的，並且該語言引入的相關的語義是非常新的，對大多數工程師來說，非常令人困惑。防止在代碼庫中引入似乎是更安全的選擇。我們更新了工具來捕獲對不允許類型的引用，並保留了現有的指南規則，建議使用其他類型的智能指針。

時間飛逝。工程師有機會適應語義的語義，我們也越來越相信使用直接符合我們的風格指南的目標。在函數調用處上，所提供的關於對象所有權的信息使讀者更容易理解該代碼。引入這種新類型所增加的複雜性，以及隨之而來的新的語義，仍然是一個值得關注的問題，但是代碼庫長期整體狀態的顯著改善使得采用是一個值得的權衡。

構建一致性

’’’

我們的風格指南還包含了一些規則，涵蓋了許多較小的內容。對於這些規則，我們主要是爲了做出和記錄一個決定。這類規則中的許多規則都沒有重大的技術影響。諸如命名約定、縮進間距、導入順序等通常一種形式相對於另一種形式沒有明確的、可衡量的技術優勢，這可能是技術社區傾向於對它們爭論不休的原因。選擇一個，我們就退出了無休止的辯論循環，可以繼續前進了。我們的工程師不再花時間去討論兩個空格與四個空格。這類規則的重要部分不是我們爲給定的規則選擇的內容，而是我們選擇的這個動作本身。

>’>>這樣的討論實際上只是在騎自行車，是對帕金森法則的零散的描述。

至於其他的一切

’’’’’’

除此之外，還有很多內容不在我們的風格指南中。我們試着專注於那些對我們代碼庫的健康狀況有重大影響的事情。這些文檔中絕對有一些沒有詳細說明的最佳實踐，包括許多很好的工程建議不要自做聰明，不要分支代碼庫，不要重新發明輪子，等等。像我們的風格指南這樣的文檔不能讓一個完全的新手擁有軟件工程大師的理解有些事情是我們假設的，這是故意的。

改變規則

’

我們的風格指南不是一成不變的。與大多數事情一樣，隨着時間的推移，做出風格指導決策的環境和指導給定裁決的因素可能會發生變化。有時，情況的變化足以使人們需要重新評估。如果發佈了新的語言版本，我們可能需要更新規則以允許或排除新的特性和習慣用法。如果某個規則是工程師需要付出努力來規避它的，我們可能需要重新審視該規則本來應該提供的好處。如果我們用來執行規則的工具變得過於複雜和難於維護，那麼規則本身可能已經腐化，需要重新修訂。注意到一條規則何時準備好，以便再次審視，這是過程中的一個重要部分，它使我們的規則集保持相關性和時效性。

’

在我們的風格指南中，規則背後的決定是有證據支持的。在添加規則時，我們將花時間討論和分析相關的利弊以及潛在的後果，並試圖驗證給定的更改是否適合谷歌運營規模。谷歌風格指南中的大多數條目都包含了這些考慮因素，列出了在過程中權衡的利弊，並給出了最終裁決的理由。理想情況下，我們優先考慮這種詳細的推理，並將其包含在每條規則中。

記錄給定決策背後的原因，使我們能夠識別何時需要更改。考慮到時間的流逝和環境的變化，以前做出的好決定可能不是現在的最佳決定。明確地指出影響因素後，我們就能夠確定何時與一個或多個因素相關的更改需要重新評估規則。

案例分析：駝峯命名法

’’

在谷歌，當我們爲代碼定義初始風格指導時，我們選擇使用駝峯命名風格，而不是使用命名風格來命名方法名。儘管公共風格指南和大多數社區使用了命名，但當時谷歌的大多數用法是爲開發人員使用作爲代碼庫之上的腳本層。許多定義的類型是相應類型的包裝器，因爲的命名慣例遵循駝峯命名風格，在這裏跨語言的一致性被視爲關鍵。

後來，我們到了構建和支持獨立應用程序的地步。最經常使用的工程師是那些開發項目的工程師，而不是編寫快速腳本的工程師。我們給我們的工程師造成了一定程度的尷尬和可讀性問題，要求他們爲我們的內部代碼維護一個標準，但每次他們引用外部代碼時都要不斷地調整另一個標準。我們還讓有經驗的新員工更難以適應我們的代碼庫規範。

隨着項目的增長，我們的代碼與外部項目的交互越來越頻繁。我們在一些項目中合併了第三方庫，導致我們的代碼庫中混合了我們自己的駝峯命名格式和外部偏愛的樣式。當我們開始開源我們的一些項目時，在一個我們的沒有約定規範限制的外部世界中維護它們，既增加了我們的複雜性，也增加了社區對我們風格的警惕，他們覺得我們的風格令人驚訝，有些怪異。

提出這些論點後，討論了成本失去與其他谷歌代碼的一致性，對習慣於我們的風格的員工進行再教育和好處獲得與大多數其他代碼的一致性，允許已經泄露到第三方庫的內容，風格指南的風格仲裁者決定改變規則。有了它被應用爲文件範圍的選擇的限制，現有代碼的例外，以及項目決定什麼最適合他們的自由度，谷歌風格指南已更新爲允許命名。

過程

“”

考慮到我們所追求的長生命週期和擴展能力，我們認識到事情需要改變，因此我們創建了一個更新規則的過程。改變我們的風格指南的過程是基於解決方案的。風格指南更新的建議是以此觀點爲框架的，識別現有的問題，並將建議的更改作爲修復問題的一種方法。在這個過程中，“問題”並不是可能出錯的假設例子問題是通過在現有谷歌代碼中發現的模式來證明的。給定一個被證明的問題，因爲我們有現有風格指南決策背後的詳細理由，我們可以重新評估，檢查和之前不同的結論現在是否更有意義。

編寫風格指南所規範的代碼的工程師羣體，往往最能注意到何時需要改變規則。事實上，在谷歌，我們的風格指南的大多數改變都是從社區討論開始的。任何工程師都可以提出問題或提出更改建議，通常從專門用於討論風格指南的特定語言郵件列表開始。

關於風格指南更改的建議可能是完整的，包括建議的具體的、更新的建議，或者可能以關於給定規則的適用性的模糊問題開始。社區會討論新想法，並接收其他語言用戶的反饋。一些提案被社區共識拒絕，被認爲是不必要的、過於模糊的或無益的。另一些則收到了積極的反饋，被認爲是有價值的，或者有一些建議的改進。這些提案，經過社區審查後，需要得到最終決策的批准。

風格仲裁者

’’’

在谷歌，對於每種語言的風格指南，最終的決定和批准都是由風格指南的所有者我們的風格仲裁者做出的。對於每一種編程語言，都有一羣資深的語言專家是風格指南的所有者和指定的決策者。特定語言的風格仲裁人通常是該語言庫團隊的高級成員，以及其他具有相關語言經驗的長期谷歌員工。

’“”

對於任何風格指南的更改，實際的決策都是對提議修改的工程權衡的反覆討論。仲裁者在風格指南優化的一致目標上下文中做出決定。更改並非根據個人喜好。它們是權衡判斷。事實上，風格仲裁組目前由四個成員組成。這可能看起來很奇怪如果委員會成員人數爲奇數，就可以防止出現出現意見分歧的情況，出現票數平手的情況。然而，由於決策制定方法的本質，沒有什麼是“因爲我認爲它應該是這樣的”，一切都是一種權衡，決策是通過共識而不是投票做出的。這個由四名成員組成的小組就這樣愉快地運作着。

例外

沒錯，我們的規則就是法律，但也有例外。我們的規則通常是爲更大的一般情況而設計的。有時，特定的情況會受益於對特定規則的豁免。當出現這種情況時，會諮詢風格仲裁者，以確定是否存在授予某個特定規則豁免的有效案例。

豁免不是輕易就能獲得的。在代碼中，如果引入了宏，風格指南要求使用特定於項目的前綴來命名它。由於處理宏的方式，將它們視爲全局命名空間的成員，所有從頭文件導出的宏必須具有全局唯一的名稱，以防止衝突。關於宏命名的風格指南規則確實允許對一些真正全局的實用宏進行仲裁授予的豁免。但是，當請求排除項目特定前綴的豁免請求背後的原因歸結爲由於宏名稱長度或項目一致性而導致的偏好時，豁免被拒絕。這裏代碼庫的完整性勝過項目的一致性。

’

在被認爲允許違反規則比避免違反規則更有利的情況下，允許例外。風格指南不允許隱式類型轉換，包括單參數構造函數。然而，對於那些被設計成透明地包裝其他類型的類型，其中的底層數據仍然被精確地表示出來，允許隱式轉換是完全合理的。在這種情況下，授予對無隱式轉換規則的豁免。擁有如此明確的有效豁免案例可能表明需要澄清或修改相關規則。然而對於此特定規則，收到了足夠多的豁免請求，這些請求似乎適合豁免的有效案例，但實際上不符合。因爲所討論的特定類型實際上不是透明包裝器類型，或者因爲該類型是包裝器但實際上並不需要保持原樣的規則仍然是值得的。

指導

除了規則之外，我們還以各種形式提供編程指導，從對複雜主題的長而深入的討論到對我們認可的最佳實踐的簡短而有針對性的建議。

’’“”“”

指導代表了我們收集的工程經驗的智慧，記錄了我們從一路走來的經驗教訓中提取的最佳實踐。指導往往側重於我們觀察到人們經常出錯的事情或不熟悉並因此容易混淆的新事物。如果規則是“必須”，那麼我們的指導就是“應該”。

’

我們培養的指導庫的一個例子是我們使用的一些主要語言的編寫入門指南。雖然我們的風格指南是規範性的，規定了哪些語言特性是允許的，哪些是不允許的，而入門指南是描述性的，解釋了指南認可的特性。他們的內容相當廣泛，幾乎涵蓋了谷歌新使用該語言的工程師需要參考的所有主題。它們不會深入研究特定主題的每一個細節，但它們提供解釋和推薦使用。當工程師需要弄清楚如何應用他們想要使用的功能時，入門指南的目的是作爲指導參考。

“”’“”

幾年前，我們開始發佈一系列提示，其中包括通用語言建議和谷歌特有的提示。我們涵蓋了困難的事情對象生命期、複製和移動語義、依賴於參數的查找新事物特性，它們在代碼庫中被採用，預採用的類型，如和還有一些東西需要溫和的調整提醒不要使用指令，警告要記住尋找隱式布爾轉換。這些技巧來源於所遇到的實際問題，解決了樣式指南中沒有涉及的實際編程問題。與風格指南中的規則不同，它們的建議並不是真正的經典它們仍然屬於建議而非規則的範疇。然而，考慮到它們是從觀察到的模式而不是抽象的理想中發展出來的，它們廣泛而直接的適用性使它們有別於大多數其他建議，成爲一種“共同的經典”。這些小貼士的內容都比較狹隘，篇幅也相對較短，每一條都不超過幾分鐘的閱讀時間。這個“每週技巧”系列在內部已經非常成功，在代碼評審和技術討論中經常被引用。

“<>”

軟件工程師進入一個新的項目或代碼庫時，已經掌握了他們將要使用的編程語言的知識，但缺乏關於如何在中使用該編程語言的知識。爲了彌補這一差距，我們爲使用中的每一種主要編程語言設置了一系列的“<語言>”課程。這些全日制課程側重於在我們的代碼庫中使用該語言進行開發的不同之處。它們涵蓋了最常用的庫和習慣用法、內部首選項和自定義工具的使用。對於一個剛剛成爲谷歌工程師的工程師，該課程填補了缺失的部分，使他們不僅是一名優秀的工程師，而且是一名優秀的代碼庫工程師。

“’’”

除了教授旨在讓完全不熟悉我們的人快速運行的課程外，我們還爲深入代碼庫的工程師培養現成的參考資料，以便在學習途中找到可以幫助他們的信息。這些參考資料的形式各不相同，並且跨越了我們使用的語言。我們內部維護的一些有用的參考資料包括：

針對通常很難正確處理的領域如併發性和散列提供特定語言的建議。語言更新中引入的新特性的詳細分解，以及如何在代碼庫中使用它們的建議。我們庫提供的關鍵抽象和數據結構列表。這阻止了我們重新創建已經存在的結構，並提供了對“我需要一個東西，但我不知道它在我們的庫中叫什麼”的回應。

>>>選擇了一些我們最受歡迎的提示。

應用規則

’

就其本質而言，規則在可執行的情況下會帶來更大的價值。規則可以通過教學和培訓在社會上執行，也可以在技術上通過工具來執行。我們在谷歌提供了各種正式的培訓課程，涵蓋了我們的規則所要求的許多最佳實踐。我們還投入資源使我們的文檔保持更新，以確保參考材料保持準確和最新。當涉及到對規則的瞭解和理解時，我們整體培訓方法的一個關鍵部分是代碼評審所扮演的角色。我們在谷歌運行的可讀性過程在這裏，針對特定語言的谷歌開發環境的新工程師會通過代碼審查來指導在很大程度上是爲了培養我們的風格指南所要求的習慣和模式詳見第章可讀性過程。這個過程是我們如何確保這些實踐是跨項目邊界學習和應用的重要部分。

儘管一定程度的培訓總是必要的畢竟，工程師必須學習規則，這樣他們才能編寫遵循規則的代碼但在檢查合規性時，我們強烈傾向於不完全依賴基於工程師的驗證使用工具自動執行。

自動執行規則可確保隨着時間的推移或組織規模的擴大，規則不會被丟棄或遺忘。新的人加入；他們可能還不知道所有的規則。規則會隨着時間而改變即使有良好的溝通，也不是每個人都能記住所有事情的當前狀態。項目不斷發展並添加新功能以前不相關的規則突然適用了。檢查規則合規性的工程師取決於記憶或文檔，這兩者都可能失敗。只要我們的工具保持更新，與我們的規則更改同步，我們就知道我們的規則被我們所有的工程師應用於我們所有的項目。

’

自動執行的另一個優點是最大限度地減少了規則解釋和應用的差異性。當我們編寫腳本或使用工具檢查合規性時，我們會根據一個單一的、不變的規則定義來驗證所有輸入。我們不會將解釋留給每個單獨的工程師。人類工程師以帶有偏見的視角看待一切。無論是否是無意識的，潛在的微妙的，甚至可能是無害的，偏見仍然會改變人們看待事物的方式。如果讓工程師來執行這些規則，可能會導致對規則的解釋和應用不一致，對責任的期望也可能不一致。我們授權給工具的越多，留給人類偏見進入的入口就越少。

’

工具還使執行具有可擴展性。隨着組織的成長，一個專家團隊就可以編寫公司其他部門都可以使用的工具。如果公司的規模擴大一倍，在整個組織內執行所有規則的成本不會增加一倍，它與以前差不多。

“”“’”“”“’”“”“”’

即使具有我們通過合併工具獲得的優勢，也可能無法自動執行所有規則。一些技術規則明確要求人的判斷。例如，在風格指南中“避免複雜的模板元編程。”“使用來避免冗長、明顯或不重要的類型名，這些類型名不能幫助讀者清晰地讀懂。“組合通常比繼承更合適。”在風格指南中“對於如何對類的成員和初始化程序進行排序並沒有一個正確的方法不同的類可能以不同的方式排列內容。”“對所捕獲的異常不做任何響應很少是正確的。覆蓋的情況極爲罕見。對於所有這些規則，都需要人工判斷，工具目前還不能代替判斷。

’’’

其他規則是社會性的而不是技術性的，用技術性的解決方案來解決社會性問題通常是不明智的。對於這個類別下的許多規則，細節往往不太明確，工具將變得複雜且昂貴。將這些規則的執行留給人類通常會更好。例如，當涉及到給定代碼更改的大小（即受影響的文件數和修改的行數）時，我們建議工程師傾向於較小的更改。對於工程師來說，小的變更更容易審覈，所以審覈往往更快、更可靠。它們也不太可能引入，因爲更容易推斷出較小更改的潛在影響和效果。然而，“小”的定義有些模糊。一個在數百個文件中傳播相同的單行更新的變化實際上可能很容易審查。相比之下，一個較小的行修改可能會引入複雜的邏輯，併產生難以評估的副作用。我們認識到有許多不同的衡量尺度，其中一些可能是主觀的特別是當考慮到變化的複雜性時。這就是爲什麼我們沒有任何工具來自動拒絕超過任意行限制的建議更改。如果審閱者認爲更改過大，他們可以而且確實會推回。對於這種規則和類似的規則，執行由編寫和審查代碼的工程師自行決定。然而，當涉及到技術規則時，只要是可行的，我們傾向於技術執行。

錯誤檢查器

許多涉及語言使用的規則可以通過靜態分析工具強制執行。事實上，我們的一些類庫管理員在年年中對風格指南進行的一項非正式調查估計，其中大約的規則可以自動驗證。錯誤檢查工具採用一組規則或模式，並驗證給定的代碼示例是否完全符合。自動驗證消除了代碼作者記住所有適用規則的負擔。如果工程師只需要查找違規警告其中許多都帶有建議的修復在代碼審查期間由已緊密集成到開發工作流中的分析器發現的，我們將儘可能減少遵守規則所需要的工作量。當我們開始使用工具基於源標籤來標記已棄用的函數時，警告和建議的就都會同時給出，新使用已棄用的問題幾乎在一夜之間消失了。降低合規成本使工程師更有可能愉快地貫徹執行。

我們使用像用於和用於這樣的工具來自動化執行規則的過程。有關我們方法的深入討論，請參見第章。

’

我們使用的工具都是爲支持我們定義的規則而設計和定製的。大多數支持規則的工具都是絕對的每個人都必須遵守規則，所以每個人都使用檢查規則的工具。有時，當工具支持最佳實踐時，在遵守約定方面有更多的靈活性，就會有選擇退出機制，允許項目根據自己的需要進行調整。

代碼格式器

在谷歌，我們通常使用自動樣式檢查器和格式化器來在我們的代碼中執行一致的格式。行長度的問題已經不再有趣了。工程師只需運行樣式檢查器並繼續前進。如果每次都以相同的方式進行格式化，那麼在代碼審查期間就不會出現問題，從而消除了用來查找、標記和修復要樣式細節的審查週期。

’

在管理有史以來最大的代碼庫時，我們有機會觀察人工格式化和自動化工具格式化的結果。平均而言，機器人比人類好很多。在某些地方，領域專業知識很重要例如，格式化矩陣，人工通常可以比通用格式化程序做得更好。如果做不到這一點，用自動樣式檢查器格式化代碼很少出錯。

我們通過預提交檢查強制使用這些格式化程序在提交代碼之前，服務會檢查在代碼上運行格式化器是否會產生任何差異。如果是，提交將被拒絕，並提供有關如何運行格式化程序以修復代碼的說明。谷歌上的大多數代碼都要接受這種預提交檢查。在我們的代碼中，使用了使用內部包裝器使用使用以及我們的文件使用。

>“”>>當你考慮到至少需要兩名工程師進行討論，並將其乘以這種對話可能在多名工程師的集合中發生的次數時，事實證明，多少個字符可能成爲一個成本非常高的問題。

案例分析：格式化工具

薩米爾·阿吉馬尼

谷歌於年月日以開源方式發佈了編程語言。從那時起，已經發展成爲一種開發服務、工具、雲基礎設施和開源軟件的語言。

我們從一開始就知道我們需要一個代碼的標準格式。我們也知道，在開源版本發佈後，幾乎不可能改造標準格式。因此，最初的版本包括，這是的標準格式工具。

動機

’’

代碼審查是一種軟件工程的最佳實踐，但是太多的時間被花在評審中爭論格式。雖然標準格式不是每個人都喜歡的，但它足以消除這些浪費的時間。

通過標準化格式，我們爲可以自動更新代碼而不會創建虛假差異的工具奠定了基礎：機器編輯的代碼與人工編輯的代碼無法區分。

例如，在年的前幾個月，團隊使用了一個名爲的工具來自動將之前的代碼更新到語言和庫的穩定版本。多虧了產生的差異只包括重要的部分：語言和使用的更改。這使程序員可以更輕鬆地查看更改並從工具所做的更改中學習。

影響

程序員希望所有的代碼都使用格式。沒有配置旋鈕，它的行爲很少改變。所有主要的編輯器和都使用或者模仿它的行爲，所以幾乎所有的代碼都採用了相同的格式。起初，用戶抱怨強制執行的標準；現在，用戶經常將作爲他們喜歡的衆多原因之一。即使閱讀不熟悉的代碼，格式也是熟悉的。

成千上萬的開源包讀取和編寫代碼。因爲所有的編輯器和都同意格式，所以工具是可移植的，並且很容易通過命令行集成到新的開發環境和工作流中。

改裝

’’

在年，我們決定使用一個新的標準格式器來自動格式化谷歌中的所有文件。文件包含了使用谷歌的構建系統構建谷歌軟件的規則。標準的格式將使我們能夠創建自動編輯文件而不破壞其格式的工具，就像工具對文件所做的那樣。

’’

一位工程師花了六週時間重新格式化了谷歌的個文件，這些文件被各個代碼所有者接受，在此期間每週都會添加一千多個新的文件。谷歌爲進行大規模變革而建立的基礎設施大大加快了這一努力。（見第章）。

>>>年月，按拉動請求衡量，是上排名第四的語言。>>’“”>>在年的演講《的文化演變》中詳細介紹了的動機、設計。>以及對和其他語言的影響。>>“‘’”>>在年解釋說，是關於自動化修改的。因此，我們有一個程序操作工具的所有硬性部分，只是坐在那裏等着被使用。同意接受風格是使其在有限的代碼量中可以做到的部分。>>>>和格式包各自有成千上萬的導入器。

結論

’

對於任何組織，尤其是像的工程師團隊這樣大的組織，規則幫助我們管理複雜性並建立一個可維護的代碼庫。一組共享的規則框定了工程流程，以便它們可以擴大規模並保持增長，從而保持代碼庫和組織的長期可持續性。

內容提要

規則和指導應旨在支持對時間和規模的擴展性。瞭解數據，以便調整規則。並非所有事情都應該成爲規則。一致性是關鍵。在可能的情況下自動化執行。